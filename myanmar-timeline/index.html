<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Myanmar in Crisis — A Chronicle</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;0,900;1,400&family=Source+Serif+4:ital,opsz,wght@0,8..60,300;0,8..60,400;0,8..60,600;0,8..60,700;1,8..60,400&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
/* ====== RESET & BASE ====== */
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{
  --serif:'Source Serif 4','Georgia',serif;
  --display:'Playfair Display','Georgia',serif;
  --sans:'Inter','Helvetica Neue',sans-serif;
  --bg:#faf8f5;
  --bg-alt:#f0ede8;
  --text:#1a1a1a;
  --text-secondary:#4a4a4a;
  --text-muted:#888;
  --accent:#8b0000;
  --accent-light:#c4302b;
  --border:#d4d0c8;
  --border-light:#e8e4dc;
  --gold:#b8860b;
  --card-bg:#ffffff;
  --shadow:0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
  --shadow-hover:0 8px 24px rgba(0,0,0,0.12), 0 4px 8px rgba(0,0,0,0.06);
  --timeline-width:200px;
}
html{scroll-behavior:smooth;font-size:16px}
body{
  font-family:var(--serif);
  background:var(--bg);
  color:var(--text);
  line-height:1.7;
  -webkit-font-smoothing:antialiased;
  overflow-x:hidden;
}
::selection{background:rgba(139,0,0,0.15);color:var(--text)}

/* ====== HERO ====== */
.hero{
  position:relative;
  min-height:100vh;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  text-align:center;
  padding:3rem 2rem;
  background:linear-gradient(180deg, #1a1a1a 0%, #2d1f1f 40%, #3d2222 100%);
  color:#f0ede8;
  overflow:hidden;
}
.hero::before{
  content:'';position:absolute;inset:0;
  background:url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.02'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
}
.hero-content{position:relative;z-index:1;max-width:800px}
.hero-dateline{
  font-family:var(--sans);font-size:0.75rem;letter-spacing:0.2em;
  text-transform:uppercase;color:rgba(255,255,255,0.5);margin-bottom:2rem;
}
.hero h1{
  font-family:var(--display);font-size:clamp(2.5rem,6vw,4.5rem);
  font-weight:900;line-height:1.1;margin-bottom:1rem;letter-spacing:-0.02em;
}
.hero h1 em{font-style:italic;color:var(--accent-light);display:block;font-size:0.7em;margin-top:0.3em}
.hero-sub{
  font-family:var(--serif);font-size:clamp(1rem,2vw,1.3rem);
  color:rgba(255,255,255,0.65);max-width:600px;margin:0 auto 2.5rem;font-weight:300;line-height:1.6;
}
.hero-meta{font-family:var(--sans);font-size:0.7rem;color:rgba(255,255,255,0.35);letter-spacing:0.15em;text-transform:uppercase}
.hero-scroll{
  position:absolute;bottom:2rem;left:50%;transform:translateX(-50%);z-index:1;
  display:flex;flex-direction:column;align-items:center;gap:0.5rem;
  color:rgba(255,255,255,0.35);font-family:var(--sans);font-size:0.65rem;
  letter-spacing:0.15em;text-transform:uppercase;animation:pulse 2s infinite;
}
.hero-scroll::after{content:'';width:1px;height:30px;background:rgba(255,255,255,0.2)}
@keyframes pulse{0%,100%{opacity:0.4}50%{opacity:0.8}}

/* ====== NAV ====== */
.nav{
  position:sticky;top:0;z-index:100;
  background:rgba(250,248,245,0.95);backdrop-filter:blur(12px);
  border-bottom:1px solid var(--border-light);transition:box-shadow 0.3s;
}
.nav.scrolled{box-shadow:0 2px 8px rgba(0,0,0,0.06)}
.nav-inner{
  max-width:1400px;margin:0 auto;padding:0 2rem;
  display:flex;align-items:center;gap:1rem;height:56px;
}
.nav-title{font-family:var(--display);font-size:0.95rem;font-weight:700;color:var(--accent);white-space:nowrap;flex-shrink:0}
.nav-divider{width:1px;height:24px;background:var(--border);flex-shrink:0}
.nav-filters{
  display:flex;gap:0.4rem;overflow-x:auto;scrollbar-width:none;
  -ms-overflow-style:none;flex:1;padding:4px 0;
}
.nav-filters::-webkit-scrollbar{display:none}
.filter-btn{
  font-family:var(--sans);font-size:0.7rem;font-weight:500;
  padding:5px 12px;border:1px solid var(--border);border-radius:20px;
  background:transparent;color:var(--text-secondary);cursor:pointer;
  white-space:nowrap;transition:all 0.2s;letter-spacing:0.02em;
}
.filter-btn:hover{border-color:var(--accent);color:var(--accent)}
.filter-btn.active{background:var(--accent);border-color:var(--accent);color:#fff}
.nav-search{position:relative;flex-shrink:0}
.nav-search input{
  font-family:var(--sans);font-size:0.75rem;padding:6px 12px 6px 30px;
  border:1px solid var(--border);border-radius:20px;background:transparent;
  color:var(--text);width:160px;transition:all 0.2s;outline:none;
}
.nav-search input:focus{border-color:var(--accent);width:200px}
.nav-search::before{content:'\2315';position:absolute;left:10px;top:50%;transform:translateY(-50%);font-size:0.85rem;color:var(--text-muted)}

/* ====== LANGUAGE TOGGLE ====== */
.lang-toggle{
  display:flex;
  border:1px solid var(--border);
  border-radius:20px;
  overflow:hidden;
  flex-shrink:0;
}
.lang-btn{
  font-family:var(--sans);font-size:0.65rem;font-weight:600;
  padding:4px 10px;border:none;background:transparent;
  color:var(--text-muted);cursor:pointer;transition:all 0.2s;
  letter-spacing:0.05em;
}
.lang-btn.active{background:var(--text);color:#fff}
.lang-btn:hover:not(.active){color:var(--text)}

/* ====== STATS ====== */
.stats-bar{background:var(--bg-alt);border-bottom:1px solid var(--border-light);padding:0.6rem 2rem}
.stats-inner{
  max-width:1400px;margin:0 auto;display:flex;justify-content:space-between;
  align-items:center;font-family:var(--sans);font-size:0.7rem;color:var(--text-muted);
}
.stats-count{font-weight:600;color:var(--text-secondary)}

/* ====== MAIN LAYOUT ====== */
.main-layout{max-width:1400px;margin:0 auto;display:flex;position:relative;min-height:100vh}

/* ====== LEFT TIMELINE ====== */
.timeline-rail{width:var(--timeline-width);flex-shrink:0;position:relative;padding:2rem 0 4rem}
.timeline-line{position:absolute;left:50%;top:0;bottom:0;width:2px;background:var(--border);transform:translateX(-50%)}
.timeline-progress{position:absolute;left:50%;top:0;width:2px;height:0;background:var(--accent);transform:translateX(-50%);transition:height 0.1s linear;z-index:1}

.timeline-rail-sticky{
  position:sticky;top:70px;height:calc(100vh - 80px);
  overflow-y:auto;scrollbar-width:none;-ms-overflow-style:none;padding:1rem 0;
}
.timeline-rail-sticky::-webkit-scrollbar{display:none}

.timeline-node{position:relative;z-index:2;display:flex;align-items:center;padding:0.5rem 0;cursor:pointer;transition:all 0.2s}
.timeline-node .node-dot{
  width:10px;height:10px;border-radius:50%;border:2px solid var(--border);
  background:var(--bg);position:absolute;left:50%;transform:translateX(-50%);
  transition:all 0.3s;z-index:2;
}
.timeline-node:hover .node-dot{border-color:var(--accent);transform:translateX(-50%) scale(1.3)}
.timeline-node.active .node-dot{
  background:var(--accent);border-color:var(--accent);
  transform:translateX(-50%) scale(1.2);box-shadow:0 0 0 4px rgba(139,0,0,0.15);
}
.timeline-node .node-label{
  font-family:var(--sans);font-size:0.6rem;color:var(--text-muted);
  white-space:nowrap;position:absolute;right:calc(50% + 14px);text-align:right;
  transition:color 0.2s;letter-spacing:0.02em;
}
.timeline-node.active .node-label{color:var(--accent);font-weight:600}
.timeline-node.year-node .node-dot{width:14px;height:14px;border-width:3px}
.timeline-node.year-node .node-label{font-size:0.8rem;font-weight:700;font-family:var(--display);color:var(--text)}
.timeline-node.coup-node .node-dot{
  width:16px;height:16px;background:var(--accent);border-color:var(--accent);
  box-shadow:0 0 0 4px rgba(139,0,0,0.2);
}
.timeline-node.coup-node .node-label{color:var(--accent);font-weight:700;font-size:0.65rem}

/* ====== CONTENT ====== */
.content-area{flex:1;padding:2rem 2rem 4rem 3rem;min-width:0}

/* ====== BACKGROUND SECTION ====== */
.background-section{margin-bottom:3rem;padding-bottom:2rem;border-bottom:2px solid var(--border)}
.background-section .section-label{
  font-family:var(--sans);font-size:0.65rem;font-weight:600;
  text-transform:uppercase;letter-spacing:0.2em;color:var(--text-muted);margin-bottom:0.5rem;
}
.background-section .section-title{font-family:var(--display);font-size:1.6rem;font-weight:700;margin-bottom:0.5rem}
.background-section .section-desc{
  font-family:var(--serif);font-size:0.9rem;color:var(--text-secondary);
  max-width:600px;line-height:1.6;margin-bottom:1.5rem;
}

/* ====== COUP DIVIDER ====== */
.coup-divider{margin:3rem 0;text-align:center;position:relative}
.coup-divider::before{content:'';position:absolute;left:0;right:0;top:50%;height:3px;background:var(--accent)}
.coup-divider-inner{position:relative;display:inline-block;background:var(--bg);padding:1.5rem 3rem}
.coup-divider .coup-date{
  font-family:var(--sans);font-size:0.65rem;letter-spacing:0.25em;
  text-transform:uppercase;color:var(--accent);margin-bottom:0.5rem;font-weight:600;
}
.coup-divider h2{font-family:var(--display);font-size:1.8rem;font-weight:900;color:var(--accent);margin-bottom:0.4rem}
.coup-divider p{font-family:var(--serif);font-size:0.85rem;color:var(--text-secondary);max-width:460px;margin:0 auto;line-height:1.5}

/* ====== YEAR MARKER ====== */
.year-marker{padding:3rem 0 1rem}
.year-marker h2{font-family:var(--display);font-size:3rem;font-weight:900;color:var(--text);opacity:0.1;letter-spacing:-0.03em}
.year-marker .year-label{font-family:var(--sans);font-size:0.6rem;text-transform:uppercase;letter-spacing:0.2em;color:var(--text-muted);margin-top:0.2rem}

/* ====== MONTH ====== */
.month-section{margin-bottom:2.5rem;scroll-margin-top:80px}
.month-header{
  display:flex;align-items:baseline;gap:1rem;
  padding-bottom:0.6rem;border-bottom:2px solid var(--text);margin-bottom:1.25rem;
}
.month-header h3{font-family:var(--display);font-size:1.35rem;font-weight:700}
.month-header .issue-num{font-family:var(--sans);font-size:0.6rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.1em}

/* ====== ARTICLE GRID ====== */
.articles-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem}

/* ====== HIGHLIGHT CARD (photo background) ====== */
.article-card.photo-card{
  position:relative;border-radius:6px;overflow:hidden;cursor:pointer;
  min-height:240px;display:flex;flex-direction:column;justify-content:flex-end;
  transition:all 0.35s ease;background-size:cover;background-position:center;
  background-color:#2a2a2a;grid-column:1/-1;
}
.article-card.photo-card::before{
  content:'';position:absolute;inset:0;
  background:linear-gradient(0deg, rgba(0,0,0,0.85) 0%, rgba(0,0,0,0.5) 40%, rgba(0,0,0,0.15) 70%, rgba(0,0,0,0.05) 100%);
  transition:all 0.35s;z-index:1;
}
.article-card.photo-card:hover::before{
  background:linear-gradient(0deg, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.6) 50%, rgba(0,0,0,0.3) 100%);
}
.article-card.photo-card:hover{transform:translateY(-3px);box-shadow:var(--shadow-hover)}
.article-card.photo-card .card-content{position:relative;z-index:2;padding:1.5rem 1.75rem;color:#fff}
.article-card.photo-card .card-title{
  font-size:1.2rem;font-weight:700;color:#fff;text-shadow:0 1px 3px rgba(0,0,0,0.3);
}
.article-card.photo-card .card-type{color:rgba(255,255,255,0.7)}
.article-card.photo-card .card-type .type-dot{background:var(--accent-light)}
.article-card.photo-card .tag{background:rgba(255,255,255,0.15);color:rgba(255,255,255,0.85);backdrop-filter:blur(4px)}
.article-card.photo-card .person-pill{border-color:rgba(255,255,255,0.25);color:rgba(255,255,255,0.7)}

/* Photo-card themed tags */
.article-card.photo-card .tag-coup{background:rgba(139,0,0,0.6);color:#fff}
.article-card.photo-card .tag-sanctions{background:rgba(26,58,139,0.5);color:#fff}
.article-card.photo-card .tag-economy{background:rgba(26,107,26,0.5);color:#fff}
.article-card.photo-card .tag-human_rights{background:rgba(139,26,74,0.5);color:#fff}
.article-card.photo-card .tag-china{background:rgba(184,98,11,0.5);color:#fff}
.article-card.photo-card .tag-resistance{background:rgba(58,58,139,0.5);color:#fff}
.article-card.photo-card .tag-ethnic_conflict{background:rgba(122,90,11,0.5);color:#fff}
.article-card.photo-card .tag-energy{background:rgba(11,106,122,0.5);color:#fff}
.article-card.photo-card .tag-international{background:rgba(74,74,107,0.5);color:#fff}
.article-card.photo-card .tag-aung_san_suu_kyi{background:rgba(139,26,74,0.5);color:#fff}

/* Background (pre-coup) photo cards */
.article-card.photo-card.background-card{filter:saturate(0.5) brightness(0.9);min-height:160px}
.article-card.photo-card.background-card:hover{filter:saturate(0.8) brightness(1)}

/* ====== TEXT CARD (regular articles) ====== */
.article-card.text-card{
  background:var(--card-bg);border:1px solid var(--border-light);
  border-radius:4px;padding:1.1rem 1.35rem;cursor:pointer;
  transition:all 0.25s ease;position:relative;
}
.article-card.text-card:hover{
  box-shadow:var(--shadow-hover);border-color:var(--border);transform:translateY(-2px);
}
.article-card.text-card .card-content{color:var(--text)}
.article-card.text-card .card-type{
  font-family:var(--sans);font-size:0.55rem;font-weight:600;
  text-transform:uppercase;letter-spacing:0.12em;color:var(--accent);margin-bottom:0.3rem;
}
.article-card.text-card .card-type .type-dot{background:var(--accent)}
.article-card.text-card .card-title{
  font-family:var(--serif);font-size:0.92rem;font-weight:600;line-height:1.5;
  color:var(--text);margin-bottom:0.6rem;
}

/* Text card tag colors */
.tag{
  font-family:var(--sans);font-size:0.5rem;font-weight:600;
  padding:2px 8px;border-radius:2px;text-transform:uppercase;letter-spacing:0.06em;
}
.tag-coup{background:#f8e8e8;color:#8b0000}
.tag-sanctions{background:#e8ecf8;color:#1a3a8b}
.tag-economy{background:#e8f4e8;color:#1a6b1a}
.tag-human_rights{background:#f8e8f4;color:#6b1a5b}
.tag-china{background:#fef3e3;color:#b8620b}
.tag-resistance{background:#eef0f8;color:#3a3a8b}
.tag-ethnic_conflict{background:#f5eee3;color:#7a5a0b}
.tag-energy{background:#e3f5f8;color:#0b6a7a}
.tag-international{background:#e8e8f0;color:#4a4a6b}
.tag-aung_san_suu_kyi{background:#fbe8f0;color:#8b1a4a}

.card-tags{display:flex;flex-wrap:wrap;gap:0.3rem}
.card-people{display:flex;flex-wrap:wrap;gap:0.25rem;margin-top:0.35rem}
.person-pill{
  font-family:var(--sans);font-size:0.5rem;font-weight:500;
  padding:1px 6px;border-radius:8px;border:1px solid var(--border);
  color:var(--text-muted);letter-spacing:0.02em;
}

/* ====== MODAL ====== */
.modal-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:200;
  display:none;justify-content:center;align-items:center;padding:2rem;
  opacity:0;transition:opacity 0.3s;backdrop-filter:blur(4px);
}
.modal-overlay.show{display:flex;opacity:1}
.modal{
  background:var(--card-bg);border-radius:6px;max-width:640px;width:100%;
  max-height:80vh;overflow-y:auto;position:relative;box-shadow:0 20px 60px rgba(0,0,0,0.3);
}
.modal-hero{width:100%;height:200px;background-size:cover;background-position:center;position:relative}
.modal-hero::after{content:'';position:absolute;inset:0;background:linear-gradient(0deg, var(--card-bg) 0%, rgba(255,255,255,0.3) 60%, transparent 100%)}
.modal-body-content{padding:0 2.5rem 2.5rem;margin-top:-1.5rem;position:relative;z-index:1}
.modal-top-bar{
  position:absolute;top:0.75rem;right:0.75rem;display:flex;gap:0.4rem;z-index:10;
}
.modal-close,.modal-share{
  background:rgba(0,0,0,0.4);border:none;font-size:1.2rem;cursor:pointer;color:#fff;
  line-height:1;padding:6px 10px;border-radius:4px;transition:background 0.2s;
}
.modal-close:hover,.modal-share:hover{background:rgba(0,0,0,0.7)}
.modal-share{font-size:0.75rem;font-family:var(--sans);font-weight:500;display:flex;align-items:center;gap:4px}
.modal-share .copied{color:var(--gold);font-weight:600}
.modal-type{font-family:var(--sans);font-size:0.65rem;font-weight:600;text-transform:uppercase;letter-spacing:0.15em;color:var(--accent);margin-bottom:0.5rem}
.modal-date{font-family:var(--sans);font-size:0.7rem;color:var(--text-muted);margin-bottom:0.75rem}
.modal-title{font-family:var(--display);font-size:1.5rem;font-weight:700;line-height:1.3;margin-bottom:1.25rem;color:var(--text)}
.modal-tags{display:flex;flex-wrap:wrap;gap:0.4rem;margin-bottom:0.5rem}
.modal-tags .tag{background:var(--bg-alt);color:var(--text-secondary)}
.modal-people{display:flex;flex-wrap:wrap;gap:0.4rem;margin-bottom:1.5rem}
.modal-people .person-pill{border-color:var(--border);color:var(--text-muted)}
.modal-text{font-family:var(--serif);font-size:0.95rem;line-height:1.8;color:var(--text-secondary);border-top:1px solid var(--border-light);padding-top:1.25rem}
.modal-text p{margin-bottom:0.75rem}
.modal-context{font-family:var(--sans);font-size:0.75rem;color:var(--text-muted);background:var(--bg-alt);padding:1rem;border-radius:4px;margin-top:1rem}

/* ====== MISC ====== */
.back-top{
  position:fixed;bottom:2rem;right:2rem;z-index:50;background:var(--accent);color:#fff;
  border:none;width:40px;height:40px;border-radius:50%;cursor:pointer;font-size:1.1rem;
  display:none;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(139,0,0,0.3);transition:all 0.2s;
}
.back-top.show{display:flex}
.back-top:hover{transform:scale(1.1)}
.no-results{text-align:center;padding:4rem 2rem;font-family:var(--sans);color:var(--text-muted)}
.no-results h3{font-size:1.1rem;margin-bottom:0.5rem;color:var(--text-secondary)}
.no-results p{font-size:0.85rem}
.footer{text-align:center;padding:3rem 2rem;border-top:1px solid var(--border-light);font-family:var(--sans);font-size:0.7rem;color:var(--text-muted);background:var(--bg-alt)}
.footer a{color:var(--accent);text-decoration:none}
.footer a:hover{text-decoration:underline}
.loading{display:flex;justify-content:center;align-items:center;min-height:50vh;font-family:var(--sans);color:var(--text-muted);font-size:0.85rem}
.loading::before{content:'';width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 0.8s linear infinite;margin-right:0.75rem}
@keyframes spin{to{transform:rotate(360deg)}}

.fade-in{opacity:0;transform:translateY(20px);transition:opacity 0.5s ease, transform 0.5s ease}
.fade-in.visible{opacity:1;transform:translateY(0)}

/* ====== RESPONSIVE ====== */
@media(max-width:1100px){:root{--timeline-width:170px}.timeline-node .node-label{font-size:0.55rem}}
@media(max-width:900px){
  .main-layout{flex-direction:column}
  .timeline-rail{display:none}
  .content-area{padding:1.5rem}
  .nav-inner{gap:0.5rem;padding:0 1rem}
  .nav-search input{width:100px}
  .nav-search input:focus{width:140px}
}
@media(max-width:600px){
  .nav-title{font-size:0.8rem}.nav-divider{display:none}
  .month-header h3{font-size:1.2rem}
  .lang-btn{font-size:0.6rem;padding:3px 7px}
}

/* ====== MODAL AUTH FORM ====== */
.modal-auth{
  text-align:center;padding:2rem 0 0.5rem;
  border-top:1px solid var(--border-light);margin-top:1rem;
}
.modal-auth p{
  font-family:var(--sans);font-size:0.8rem;color:var(--text-muted);
  margin-bottom:1rem;line-height:1.5;
}
.modal-auth-form{display:flex;gap:0.5rem;justify-content:center;align-items:center;flex-wrap:wrap}
.modal-auth-input{
  font-family:var(--sans);font-size:0.8rem;
  padding:8px 14px;width:220px;
  border:1px solid var(--border);border-radius:4px;
  background:var(--bg-alt);color:var(--text);outline:none;transition:border-color 0.2s;
}
.modal-auth-input::placeholder{color:var(--text-muted)}
.modal-auth-input:focus{border-color:var(--accent)}
.modal-auth-submit{
  font-family:var(--sans);font-size:0.75rem;font-weight:600;
  padding:8px 18px;border:none;border-radius:4px;
  background:var(--accent);color:#fff;cursor:pointer;
  letter-spacing:0.03em;transition:all 0.2s;
}
.modal-auth-submit:hover{background:var(--accent-light)}
.modal-auth-error{
  font-family:var(--sans);font-size:0.7rem;
  color:var(--accent-light);margin-top:0.5rem;width:100%;
}
.modal-auth-status{
  font-family:var(--sans);font-size:0.7rem;color:var(--text-muted);
  margin-top:0.5rem;
}
.modal-auth-status a{color:var(--accent);cursor:pointer;text-decoration:underline}

/* ====== READING PROGRESS BAR ====== */
.progress-bar{
  position:fixed;top:0;left:0;height:3px;z-index:9999;
  background:linear-gradient(to right, var(--accent), var(--gold));
  width:0;transition:width 0.1s linear;pointer-events:none;
}

/* ====== FILTER COUNT BADGES ====== */
.filter-count{
  display:inline-block;font-size:0.55rem;font-weight:700;
  background:var(--text-muted);color:#fff;border-radius:8px;
  padding:0 5px;margin-left:4px;min-width:16px;text-align:center;
  line-height:1.4;vertical-align:middle;transition:all 0.3s;
}
.filter-btn.active .filter-count{background:rgba(255,255,255,0.35)}
.filter-btn:not(.active) .filter-count{background:var(--border)}

/* ====== YEAR DIVIDER (enhanced) ====== */
.year-divider{padding:3rem 0 1.5rem;border-top:2px solid var(--border);margin:2.5rem 0 0.5rem;position:relative}
.year-divider:first-child{border-top:none;margin-top:0}
.year-divider h2{font-family:var(--display);font-size:3.5rem;font-weight:900;color:var(--text);letter-spacing:-0.03em;line-height:1}
.year-divider .year-context{
  font-family:var(--serif);font-size:1rem;color:var(--text-secondary);
  margin-top:0.5rem;font-style:italic;font-weight:300;
}

/* ====== ANALYSIS CARD ACCENT ====== */
.article-card.text-card.analysis-card{border-left:3px solid var(--gold)}
.article-card.text-card.analysis-card .card-type{color:var(--gold)}
.article-card.text-card.analysis-card .card-type .type-dot{background:var(--gold)}

/* ====== STAGGERED CARD ANIMATION ====== */
.card-stagger-1{transition-delay:0s}
.card-stagger-2{transition-delay:0.06s}
.card-stagger-3{transition-delay:0.12s}
.card-stagger-4{transition-delay:0.18s}
.card-stagger-5{transition-delay:0.24s}
.card-stagger-6{transition-delay:0.3s}

/* ====== MOBILE TIMELINE SHEET ====== */
.mobile-timeline-btn{
  display:none;position:fixed;bottom:5rem;right:2rem;z-index:50;
  background:var(--text);color:#fff;border:none;
  padding:10px 18px;border-radius:24px;cursor:pointer;
  font-family:var(--sans);font-size:0.7rem;font-weight:600;
  letter-spacing:0.05em;box-shadow:0 4px 12px rgba(0,0,0,0.2);
  transition:all 0.2s;
}
.mobile-timeline-btn:hover{transform:scale(1.05)}
.mobile-timeline-sheet{
  position:fixed;bottom:0;left:0;right:0;max-height:55vh;
  background:var(--card-bg);border-radius:16px 16px 0 0;
  transform:translateY(100%);transition:transform 0.3s ease;
  z-index:1000;overflow-y:auto;padding:0;
  box-shadow:0 -4px 24px rgba(0,0,0,0.15);
}
.mobile-timeline-sheet.open{transform:translateY(0)}
.mobile-sheet-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,0.3);z-index:999;
  display:none;opacity:0;transition:opacity 0.3s;
}
.mobile-sheet-overlay.show{display:block;opacity:1}
.mobile-sheet-handle{
  width:36px;height:4px;background:var(--border);border-radius:2px;
  margin:10px auto 6px;
}
.mobile-sheet-header{
  font-family:var(--sans);font-size:0.7rem;font-weight:600;
  text-transform:uppercase;letter-spacing:0.15em;color:var(--text-muted);
  padding:0 1.25rem 0.5rem;border-bottom:1px solid var(--border-light);
}
.mobile-sheet-year{
  font-family:var(--display);font-size:1.1rem;font-weight:700;
  color:var(--text);padding:1rem 1.25rem 0.25rem;
}
.mobile-sheet-months{display:flex;flex-wrap:wrap;gap:0.4rem;padding:0.5rem 1.25rem 1rem}
.mobile-sheet-chip{
  font-family:var(--sans);font-size:0.7rem;font-weight:500;
  padding:6px 14px;border-radius:20px;border:1px solid var(--border);
  background:transparent;color:var(--text-secondary);cursor:pointer;
  transition:all 0.2s;
}
.mobile-sheet-chip:hover,.mobile-sheet-chip.active{
  background:var(--accent);border-color:var(--accent);color:#fff;
}

/* ====== STICKY MONTH INDICATOR (mobile) ====== */
.sticky-month{
  display:none;position:fixed;top:62px;left:50%;transform:translateX(-50%);
  background:var(--text);color:#fff;padding:4px 16px;border-radius:20px;
  font-family:var(--sans);font-size:0.7rem;font-weight:600;letter-spacing:0.03em;
  z-index:100;opacity:0;transition:opacity 0.3s;pointer-events:none;
  box-shadow:0 2px 8px rgba(0,0,0,0.2);
}
.sticky-month.visible{opacity:1}

/* ====== MOBILE RESPONSIVE OVERRIDES ====== */
@media(max-width:900px){
  .mobile-timeline-btn{display:flex;align-items:center;gap:6px}
  .sticky-month{display:block}
}
@media(max-width:768px){
  .nav-inner{flex-wrap:wrap;height:auto;padding:8px 1rem}
  .nav-filters{order:10;width:100%;padding:4px 0;gap:0.3rem;
    overflow-x:auto;scrollbar-width:none;-webkit-overflow-scrolling:touch;flex:none}
  .nav-filters::-webkit-scrollbar{display:none}
  .nav-search{order:5;flex:1;min-width:0}
  .nav-search input{width:100%}
  .nav-search input:focus{width:100%}
  .filter-btn{min-height:36px;padding:6px 14px;font-size:0.7rem}
  .article-card.text-card{padding:0.9rem 1rem}
  .article-card.photo-card{min-height:160px}
  .modal{max-width:100%;max-height:100vh;border-radius:0;margin:0}
  .modal-overlay{padding:0}
  .modal-body-content{padding:0 1.25rem 1.5rem}
  .modal-title{font-size:1.15rem}
  .article-card:active{transform:scale(0.98) !important}
  .content-area{padding:1rem}
  .hero h1{font-size:2rem}
  .coup-divider h2{font-size:1.2rem}
  .coup-divider-inner{padding:1rem 1.25rem}
}
</style>
</head>
<body>
<div class="progress-bar" id="progressBar"></div>

<!-- HERO -->
<section class="hero" id="top">
  <div class="hero-content">
    <p class="hero-dateline">A documentary timeline &middot; 2021&ndash;2026</p>
    <h1>Myanmar in Crisis<em>A Chronicle of Upheaval</em></h1>
    <p class="hero-sub">From the military coup of February 2021 through years of resistance and repression &mdash; tracing Myanmar's political and economic upheaval through primary reporting.</p>
    <p class="hero-meta">Based on the MBRI Newsletter Archive</p>
  </div>
  <div class="hero-scroll">Scroll<br></div>
</section>

<!-- NAV -->
<nav class="nav" id="nav">
  <div class="nav-inner">
    <div class="nav-title">Myanmar Chronicle</div>
    <div class="nav-divider"></div>
    <div class="nav-filters" id="filters">
      <button class="filter-btn active" data-filter="all">All</button>
      <button class="filter-btn" data-filter="coup">Coup &amp; Military</button>
      <button class="filter-btn" data-filter="sanctions">Sanctions</button>
      <button class="filter-btn" data-filter="resistance">Resistance</button>
      <button class="filter-btn" data-filter="human_rights">Human Rights</button>
      <button class="filter-btn" data-filter="china">China</button>
      <button class="filter-btn" data-filter="international">International</button>
      <button class="filter-btn" data-filter="ethnic_conflict">Ethnic Conflict</button>
      <button class="filter-btn" data-filter="economy">Economy</button>
      <button class="filter-btn" data-filter="energy">Energy</button>
      <button class="filter-btn" data-filter="aung_san_suu_kyi">Aung San Suu Kyi</button>
    </div>
    <div class="nav-divider"></div>
    <div class="lang-toggle" id="langToggle">
      <button class="lang-btn" data-lang="ko">한국어</button>
      <button class="lang-btn active" data-lang="en">EN</button>
    </div>
    <div class="nav-search">
      <input type="text" id="searchInput" placeholder="Search articles...">
    </div>
  </div>
</nav>

<!-- STATS -->
<div class="stats-bar">
  <div class="stats-inner">
    <span>Showing <span class="stats-count" id="articleCount">&mdash;</span> articles</span>
    <span id="dateRange"></span>
  </div>
</div>

<!-- MAIN -->
<div class="main-layout" id="mainLayout">
  <aside class="timeline-rail" id="timelineRail">
    <div class="timeline-line"></div>
    <div class="timeline-progress" id="timelineProgress"></div>
    <div class="timeline-rail-sticky" id="timelineSticky"></div>
  </aside>
  <main class="content-area" id="timeline">
    <div class="loading" id="loading">Loading timeline data...</div>
  </main>
</div>

<!-- MODAL -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal" id="modal">
    <div class="modal-top-bar">
      <button class="modal-share" id="modalShare" title="Copy link">&#128279; Share</button>
      <button class="modal-close" id="modalClose">&times;</button>
    </div>
    <div class="modal-hero" id="modalHero"></div>
    <div class="modal-body-content">
      <div class="modal-type" id="modalType"></div>
      <div class="modal-date" id="modalDate"></div>
      <h2 class="modal-title" id="modalTitle"></h2>
      <div class="modal-tags" id="modalTags"></div>
      <div class="modal-people" id="modalPeople"></div>
      <div class="modal-text" id="modalText"></div>
    </div>
  </div>
</div>

<button class="back-top" id="backTop" title="Back to top">&uarr;</button>
<button class="mobile-timeline-btn" id="mobileTimelineBtn">&#9776; Timeline</button>
<div class="mobile-sheet-overlay" id="mobileSheetOverlay"></div>
<div class="mobile-timeline-sheet" id="mobileTimelineSheet">
  <div class="mobile-sheet-handle"></div>
  <div class="mobile-sheet-header">Jump to month</div>
  <div id="mobileSheetContent"></div>
</div>
<div class="sticky-month" id="stickyMonth"></div>

<footer class="footer">
  <p>Data sourced from the MBRI Newsletter Archive (2016&ndash;2026). Focused on Feb 2021 onward.</p>
  <p style="margin-top:0.5rem">Built by <a href="https://gyubeanie.github.io" target="_blank">gyubeanie</a></p>
</footer>

<script>
/* ================================================================
   MYANMAR TIMELINE v4
   - Photo cards for highlights, clean text cards for the rest
   - KO/EN language toggle with pre-translated titles
   - Left timeline rail with scroll tracking
   - URL state management with shareable links
   - Reading progress bar, filter counts, staggered animations
   - Mobile timeline bottom sheet, sticky month indicator
   ================================================================ */

// ==================== AUTH (in-modal, not page-blocking) ====================
const APPROVED_EMAILS = ['hky0304@gmail.com'];
const GATE_KEY = 'myanmar-chronicle-access';

function isApproved(email) {
  if (!email) return false;
  const e = email.trim().toLowerCase();
  return APPROVED_EMAILS.some(function(a) { return a.trim().toLowerCase() === e; });
}
function isUserLoggedIn() {
  const stored = localStorage.getItem(GATE_KEY);
  if (stored && isApproved(stored)) return true;
  if (stored) localStorage.removeItem(GATE_KEY);
  return false;
}
function logoutUser() { localStorage.removeItem(GATE_KEY); }

document.addEventListener('submit', function(e) {
  if (e.target && e.target.id === 'modalAuthForm') {
    e.preventDefault();
    const input = document.getElementById('modalAuthEmail');
    const errorEl = document.getElementById('modalAuthError');
    if (!input || !errorEl) return;
    const email = input.value.trim().toLowerCase();
    if (isApproved(email)) {
      localStorage.setItem(GATE_KEY, email);
      errorEl.textContent = '';
      const currentId = document.getElementById('modal').dataset.currentArticle;
      if (currentId) openModal(currentId);
    } else {
      errorEl.textContent = 'This email is not on the access list.';
      input.focus();
    }
  }
});
document.addEventListener('click', function(e) {
  if (e.target && e.target.id === 'modalLogout') {
    e.preventDefault();
    logoutUser();
    const currentId = document.getElementById('modal').dataset.currentArticle;
    if (currentId) openModal(currentId);
  }
});

// ==================== URL STATE ====================
let suppressHashChange = false;

function stateToHash(articleId) {
  const params = [];
  if (currentFilter !== 'all') params.push('filter=' + encodeURIComponent(currentFilter));
  if (searchQuery) params.push('q=' + encodeURIComponent(searchQuery));
  if (currentLang !== 'en') params.push('lang=' + encodeURIComponent(currentLang));
  if (articleId) params.push('article=' + encodeURIComponent(articleId));
  return params.length ? '#' + params.join('&') : '';
}

function hashToState() {
  const hash = location.hash.slice(1);
  if (!hash) return;
  const params = {};
  hash.split('&').forEach(p => {
    const [k, v] = p.split('=');
    if (k && v) params[decodeURIComponent(k)] = decodeURIComponent(v);
  });

  if (params.filter) {
    currentFilter = params.filter;
    document.querySelectorAll('.filter-btn').forEach(b => {
      b.classList.toggle('active', b.dataset.filter === currentFilter);
    });
  }
  if (params.q) {
    searchQuery = params.q;
    document.getElementById('searchInput').value = searchQuery;
  }
  if (params.lang && (params.lang === 'ko' || params.lang === 'en')) {
    currentLang = params.lang;
    document.querySelectorAll('.lang-btn').forEach(b => {
      b.classList.toggle('active', b.dataset.lang === currentLang);
    });
  }
  if (params.article && allData) {
    // Defer to allow render to finish
    setTimeout(() => openModal(params.article), 100);
  }
}

function pushState(articleId) {
  const newHash = stateToHash(articleId);
  suppressHashChange = true;
  if (newHash) {
    history.replaceState(null, '', newHash);
  } else {
    history.replaceState(null, '', location.pathname);
  }
  setTimeout(() => { suppressHashChange = false; }, 50);
}

window.addEventListener('hashchange', () => {
  if (suppressHashChange) return;
  hashToState();
  if (allData) render();
});

// ==================== APP ====================

const TAG_LABELS = {
  coup:'Coup & Military', sanctions:'Sanctions', economy:'Economy',
  human_rights:'Human Rights', china:'China', resistance:'Resistance',
  ethnic_conflict:'Ethnic Conflict', energy:'Energy', international:'International',
  aung_san_suu_kyi:'Aung San Suu Kyi'
};
const MONTH_NAMES = {
  '01':'January','02':'February','03':'March','04':'April',
  '05':'May','06':'June','07':'July','08':'August',
  '09':'September','10':'October','11':'November','12':'December'
};

const THEME_PHOTOS = {
  coup: [
    'https://images.unsplash.com/photo-1620730752350-eb31be82a90c?w=800&q=80',
    'https://images.unsplash.com/photo-1635426818233-6cfe593eb3f1?w=800&q=80'
  ],
  economy: [
    'https://images.unsplash.com/photo-1699586751277-bb1d47179194?w=800&q=80',
    'https://images.unsplash.com/photo-1644810495465-04a89151ee07?w=800&q=80'
  ],
  china: [
    'https://images.unsplash.com/photo-1601822499690-afba3e54a5a4?w=800&q=80',
    'https://images.unsplash.com/photo-1683568983870-ce2e4506fcb1?w=800&q=80'
  ],
  ethnic_conflict: [
    'https://images.unsplash.com/photo-1576863555995-5cad6274b5f3?w=800&q=80',
    'https://images.unsplash.com/photo-1553419462-a2e3c6d55a0f?w=800&q=80'
  ],
  resistance: [
    'https://images.unsplash.com/photo-1616992249318-0bd168733128?w=800&q=80',
    'https://images.unsplash.com/photo-1635426522203-b888eb102b1e?w=800&q=80'
  ],
  sanctions: ['https://images.unsplash.com/photo-1679589164488-ca6dc6746af9?w=800&q=80'],
  energy: [
    'https://images.unsplash.com/photo-1753978304732-35020ea9dfc6?w=800&q=80',
    'https://images.unsplash.com/photo-1678984240126-70bcddd7a228?w=800&q=80'
  ],
  international: ['https://images.unsplash.com/photo-1679589164488-ca6dc6746af9?w=800&q=80'],
  human_rights: ['https://images.unsplash.com/photo-1727698947614-fe284fd1eb7c?w=800&q=80'],
  aung_san_suu_kyi: [
    'https://images.unsplash.com/photo-1612258000416-4954d59f98c9?w=800&q=80',
    'https://images.unsplash.com/photo-1615524340061-17304c23cc6d?w=800&q=80'
  ],
  general: [
    'https://images.unsplash.com/photo-1559241660-e208651464d9?w=800&q=80',
    'https://images.unsplash.com/photo-1655709307894-1fdbdbe2b373?w=800&q=80',
    'https://images.unsplash.com/photo-1499123785106-343e69e68db1?w=800&q=80',
    'https://images.unsplash.com/photo-1586359024637-e5bc5c8db4a3?w=800&q=80'
  ]
};

function getPhoto(article) {
  const tag = (article.tags && article.tags.length > 0) ? article.tags[0] : 'general';
  const photos = THEME_PHOTOS[tag] || THEME_PHOTOS.general;
  const hash = article.id.split('').reduce((a,c) => a + c.charCodeAt(0), 0);
  return photos[hash % photos.length];
}

const YEAR_CONTEXT = {
  '2016':'Background','2017':'Background','2018':'Background',
  '2019':'Background','2020':'Background',
  '2021':'The Military Coup','2022':'Deepening Crisis',
  '2023':'Resistance & Resilience','2024':'Stalemate',
  '2025':'Into the Unknown','2026':'The Present'
};

let allData = null;
let currentFilter = 'all';
let searchQuery = '';
let currentLang = 'en';
let currentVisibleMonth = '';

// ========== LOAD ==========
async function loadData() {
  try {
    const res = await fetch('data.json');
    allData = await res.json();
    document.getElementById('loading').remove();
    hashToState(); // Apply URL state before first render
    render();
    initScrollObserver();
    updateFilterCounts();
    buildMobileTimeline();
  } catch (e) {
    document.getElementById('loading').innerHTML =
      '<div style="text-align:center"><h3 style="font-size:1rem;margin-bottom:0.5rem">Unable to load data</h3><p style="font-size:0.8rem;color:#888">Make sure data.json is in the same directory.</p></div>';
  }
}

// ========== TITLE DISPLAY ==========
function getTitle(article) {
  if (currentLang === 'en' && article.titleEn) return article.titleEn;
  return article.title;
}
function displayTitle(article) { return cleanTitle(getTitle(article)); }
function cleanTitle(t) {
  return t.replace(/^\d+\.\s*/, '')
    .replace(/^ISSUE ANALYSIS:\s*/i, '')
    .replace(/^HOT ISSUE\s*\d*:\s*/i, '')
    .replace(/^HOT REPORT\s*\d*:\s*/i, '')
    .replace(/^HOT Report\s*\d*:\s*/i, '')
    .replace(/^EDITOR[\u2019']S CHOICE:\s*/i, '')
    .replace(/^MEMO:\s*/i, '')
    .replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&amp;/g, '&')
    .trim();
}
function formatDateLabel(d) {
  const [y, m] = d.split('-');
  return `${MONTH_NAMES[m] || m} ${y}`;
}

// ========== FILTER COUNTS ==========
function updateFilterCounts() {
  if (!allData) return;
  const allArticles = [];
  allData.issues.forEach(issue => {
    issue.articles.forEach(a => allArticles.push(a));
  });
  document.querySelectorAll('.filter-btn').forEach(btn => {
    const f = btn.dataset.filter;
    let count;
    if (f === 'all') {
      count = allArticles.length;
    } else {
      count = allArticles.filter(a => a.tags && a.tags.includes(f)).length;
    }
    let badge = btn.querySelector('.filter-count');
    if (!badge) {
      badge = document.createElement('span');
      badge.className = 'filter-count';
      btn.appendChild(badge);
    }
    badge.textContent = count;
  });
}

// ========== RENDER ==========
function render() {
  const timeline = document.getElementById('timeline');
  const issues = filterIssues();
  let totalArticles = 0;
  let html = '';
  let lastYear = '';
  let coupDividerShown = false;
  let timelineNodes = [];
  let backgroundIssues = [];

  issues.forEach(issue => { if (issue.isBackground) backgroundIssues.push(issue); });

  // Background section
  if (backgroundIssues.length > 0 && currentFilter === 'all' && !searchQuery) {
    html += `<div class="background-section">
      <div class="section-label">Background</div>
      <div class="section-title">Before the Coup</div>
      <div class="section-desc">Key events from Myanmar\u2019s democratic transition era that set the stage for the military takeover of February 2021.</div>
      <div class="articles-grid">`;
    let bgIdx = 0;
    backgroundIssues.forEach(issue => {
      filterArticles(issue.articles).forEach(a => {
        totalArticles++;
        html += renderCard(a, issue, true, bgIdx++);
      });
    });
    html += `</div></div>`;
  }

  // Post-coup
  issues.forEach(issue => {
    if (issue.isBackground) return;
    const [year, month] = issue.date.split('-');
    const articles = filterArticles(issue.articles);
    if (articles.length === 0) return;
    totalArticles += articles.length;

    if (year !== lastYear) {
      lastYear = year;
      // Enhanced year divider
      html += `<div class="year-divider fade-in" id="year-${year}">
        <h2>${year}</h2>
        ${YEAR_CONTEXT[year] ? `<div class="year-context">${YEAR_CONTEXT[year]}</div>` : ''}
      </div>`;
    }

    if (issue.date === '2021-02' && !coupDividerShown) {
      coupDividerShown = true;
      html += `<div class="coup-divider" id="coup-divider"><div class="coup-divider-inner">
        <div class="coup-date">February 1, 2021</div>
        <h2>The Military Seizes Power</h2>
        <p>Myanmar\u2019s military detains Aung San Suu Kyi and senior government leaders, declaring a one-year state of emergency and ending a decade of fragile democratic governance.</p>
      </div></div>`;
    }

    const monthName = MONTH_NAMES[month] || month;
    timelineNodes.push({ date: issue.date, label: `${monthName} ${year}`, id: `month-${issue.date}` });

    html += `<section class="month-section fade-in" id="month-${issue.date}">
      <div class="month-header">
        <h3>${monthName} ${year}</h3>
        <span class="issue-num">Issue No. ${issue.issueNum} \u00b7 ${articles.length} articles</span>
      </div><div class="articles-grid">`;

    articles.forEach((a, idx) => { html += renderCard(a, issue, false, idx); });
    html += `</div></section>`;
  });

  if (totalArticles === 0) {
    html = `<div class="no-results"><h3>No articles found</h3><p>Try adjusting your filter or search query.</p></div>`;
  }

  timeline.innerHTML = html;
  document.getElementById('articleCount').textContent = totalArticles.toLocaleString();

  const dates = issues.filter(i => !i.isBackground).map(i => i.date).sort();
  if (dates.length > 0) {
    document.getElementById('dateRange').textContent = `${formatDateLabel(dates[0])} \u2014 ${formatDateLabel(dates[dates.length - 1])}`;
  }

  buildTimeline(timelineNodes);
  initFadeIn();
  pushState(); // Sync URL
}

function renderCard(a, issue, isBackground, idx) {
  const isHL = a.isHighlight;
  const usePhoto = isHL;
  const isAnalysis = a.type === 'analysis';
  const staggerClass = `card-stagger-${((idx || 0) % 6) + 1}`;

  const typeLabel = isAnalysis ? (
    a.title.includes('HOT ISSUE') ? 'Hot Issue' :
    a.title.includes('HOT REPORT') || a.title.includes('HOT Report') ? 'Report' :
    a.title.includes('ISSUE ANALYSIS') ? 'Analysis' :
    a.title.includes("EDITOR\u2019S CHOICE") || a.title.includes("EDITOR'S CHOICE") ? "Editor\u2019s Choice" :
    'Analysis'
  ) : 'News';

  let cls, style = '';
  if (usePhoto) {
    const photo = getPhoto(a);
    cls = `article-card photo-card fade-in ${staggerClass}${isBackground ? ' background-card' : ''}`;
    style = ` style="background-image:url('${photo}')"`;
  } else {
    cls = `article-card text-card fade-in ${staggerClass}${isBackground ? ' background-card' : ''}${isAnalysis ? ' analysis-card' : ''}`;
  }

  let h = `<div class="${cls}" data-id="${a.id}"${style} onclick="openModal('${a.id}')">`;
  h += `<div class="card-content">`;
  if (typeLabel) h += `<div class="card-type"><span class="type-dot"></span>${typeLabel}</div>`;
  if (isBackground && !usePhoto) h += `<div class="card-type"><span class="type-dot"></span>${formatDateLabel(issue.date)}</div>`;
  h += `<div class="card-title">${displayTitle(a)}</div>`;

  if (a.tags && a.tags.length > 0) {
    h += `<div class="card-tags">`;
    a.tags.forEach(t => { h += `<span class="tag tag-${t}">${TAG_LABELS[t] || t}</span>`; });
    h += `</div>`;
  }
  if (a.people && a.people.length > 0) {
    h += `<div class="card-people">`;
    a.people.forEach(p => { h += `<span class="person-pill">${p}</span>`; });
    h += `</div>`;
  }
  h += `</div></div>`;
  return h;
}

// ========== FILTER ==========
function filterIssues() {
  if (!allData) return [];
  return allData.issues.filter(issue => filterArticles(issue.articles).length > 0);
}
function filterArticles(articles) {
  return articles.filter(a => {
    if (currentFilter !== 'all' && (!a.tags || !a.tags.includes(currentFilter))) return false;
    if (searchQuery) {
      const q = searchQuery.toLowerCase();
      const title = getTitle(a).toLowerCase();
      const titleOrig = a.title.toLowerCase();
      const inTitle = title.includes(q) || titleOrig.includes(q);
      const inTags = (a.tags || []).some(t => TAG_LABELS[t]?.toLowerCase().includes(q));
      const inPeople = (a.people || []).some(p => p.toLowerCase().includes(q));
      if (!inTitle && !inTags && !inPeople) return false;
    }
    return true;
  });
}

// ========== TIMELINE ==========
function buildTimeline(nodes) {
  const sticky = document.getElementById('timelineSticky');
  if (!sticky) return;
  let html = '';
  let lastYear = '';
  nodes.forEach(node => {
    const [year] = node.date.split('-');
    if (year !== lastYear) {
      lastYear = year;
      html += `<div class="timeline-node year-node" data-target="year-${year}">
        <span class="node-label">${year}</span><span class="node-dot"></span></div>`;
    }
    const isCoup = node.date === '2021-02';
    html += `<div class="timeline-node${isCoup ? ' coup-node' : ''}" data-target="${node.id}" data-date="${node.date}">
      <span class="node-label">${node.label.split(' ')[0]}</span><span class="node-dot"></span></div>`;
  });
  sticky.innerHTML = html;
  sticky.querySelectorAll('.timeline-node').forEach(n => {
    n.addEventListener('click', () => {
      const t = document.getElementById(n.dataset.target);
      if (t) t.scrollIntoView({ behavior: 'smooth', block: 'start' });
    });
  });
}

function initScrollObserver() {
  if (!('IntersectionObserver' in window)) return;
  const obs = new IntersectionObserver(entries => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        // Desktop timeline
        document.querySelectorAll('.timeline-node').forEach(n => n.classList.remove('active'));
        const node = document.querySelector(`.timeline-node[data-target="${entry.target.id}"]`);
        if (node) { node.classList.add('active'); node.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); }
        // Mobile sticky month
        const section = entry.target;
        if (section.id && section.id.startsWith('month-')) {
          const dateStr = section.id.replace('month-', '');
          currentVisibleMonth = formatDateLabel(dateStr);
          const stickyEl = document.getElementById('stickyMonth');
          if (stickyEl) stickyEl.textContent = currentVisibleMonth;
        }
      }
    });
  }, { rootMargin: '-20% 0px -70% 0px', threshold: 0 });
  document.querySelectorAll('.month-section, .year-marker, .year-divider').forEach(el => obs.observe(el));
}

function initFadeIn() {
  if (!('IntersectionObserver' in window)) { document.querySelectorAll('.fade-in').forEach(el => el.classList.add('visible')); return; }
  const obs = new IntersectionObserver(entries => {
    entries.forEach(entry => { if (entry.isIntersecting) { entry.target.classList.add('visible'); obs.unobserve(entry.target); } });
  }, { rootMargin: '0px 0px -50px 0px', threshold: 0.1 });
  document.querySelectorAll('.fade-in').forEach(el => obs.observe(el));
}

// ========== MODAL ==========
function openModal(id) {
  if (!allData) return;
  let article = null, issueDate = '';
  for (const issue of allData.issues) {
    const found = issue.articles.find(a => a.id === id);
    if (found) { article = found; issueDate = issue.date; break; }
  }
  if (!article) return;

  const overlay = document.getElementById('modalOverlay');
  const modal = document.getElementById('modal');
  modal.dataset.currentArticle = id;

  const photo = getPhoto(article);
  document.getElementById('modalHero').style.backgroundImage = `url('${photo}')`;
  document.getElementById('modalType').textContent = article.type === 'analysis' ? 'Analysis / Special Report' : 'News Report';
  document.getElementById('modalDate').textContent = formatDateLabel(issueDate);
  document.getElementById('modalTitle').textContent = displayTitle(article);

  let tagsH = '';
  (article.tags || []).forEach(t => { tagsH += `<span class="tag tag-${t}">${TAG_LABELS[t] || t}</span>`; });
  document.getElementById('modalTags').innerHTML = tagsH;

  let peopleH = '';
  (article.people || []).forEach(p => { peopleH += `<span class="person-pill">${p}</span>`; });
  document.getElementById('modalPeople').innerHTML = peopleH;

  const koTitle = cleanTitle(article.title);
  const enTitle = article.titleEn ? cleanTitle(article.titleEn) : '';

  let bodyH = `<p>This article was published in the <strong>${formatDateLabel(issueDate)}</strong> issue of the MBRI Newsletter.</p>`;
  if (enTitle && enTitle !== koTitle) {
    bodyH += `<p style="font-size:1.05rem;font-weight:600;color:var(--text);line-height:1.6">\u201C${enTitle}\u201D</p>`;
    bodyH += `<p style="font-size:0.9rem;color:var(--text-secondary);line-height:1.6">${koTitle}</p>`;
  } else {
    bodyH += `<p style="font-size:1.05rem;font-weight:600;color:var(--text);line-height:1.6">\u201C${koTitle}\u201D</p>`;
  }

  if (isUserLoggedIn()) {
    bodyH += `<div class="modal-context">Full article text will be available in a future update.</div>`;
    bodyH += `<div class="modal-auth-status">Signed in \u00b7 <a id="modalLogout">Sign out</a></div>`;
  } else {
    bodyH += `<div class="modal-auth">
      <p>Sign in to read the full article text.</p>
      <form class="modal-auth-form" id="modalAuthForm">
        <input class="modal-auth-input" type="email" id="modalAuthEmail" placeholder="your@email.com" required autocomplete="email">
        <button class="modal-auth-submit" type="submit">Sign in</button>
      </form>
      <div class="modal-auth-error" id="modalAuthError"></div>
    </div>`;
  }

  document.getElementById('modalText').innerHTML = bodyH;
  overlay.classList.add('show');
  document.body.style.overflow = 'hidden';
  pushState(id); // Add article to URL
}

function closeModal() {
  document.getElementById('modalOverlay').classList.remove('show');
  document.body.style.overflow = '';
  pushState(); // Remove article from URL
}

document.getElementById('modalClose').addEventListener('click', closeModal);
document.getElementById('modalOverlay').addEventListener('click', e => { if (e.target === e.currentTarget) closeModal(); });
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

// ========== SHARE BUTTON ==========
document.getElementById('modalShare').addEventListener('click', function() {
  const articleId = document.getElementById('modal').dataset.currentArticle;
  const url = location.origin + location.pathname + stateToHash(articleId);
  navigator.clipboard.writeText(url).then(() => {
    const btn = document.getElementById('modalShare');
    const orig = btn.innerHTML;
    btn.innerHTML = '<span class="copied">Copied!</span>';
    setTimeout(() => { btn.innerHTML = orig; }, 1500);
  }).catch(() => {
    // Fallback
    prompt('Copy this link:', url);
  });
});

// ========== FILTERS ==========
document.getElementById('filters').addEventListener('click', e => {
  const btn = e.target.closest('.filter-btn');
  if (!btn) return;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  currentFilter = btn.dataset.filter;
  render();
  const first = document.querySelector('.month-section, .background-section');
  if (first) first.scrollIntoView({ behavior: 'smooth', block: 'start' });
});

// ========== LANGUAGE TOGGLE ==========
document.getElementById('langToggle').addEventListener('click', e => {
  const btn = e.target.closest('.lang-btn');
  if (!btn || btn.classList.contains('active')) return;
  document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  currentLang = btn.dataset.lang;
  render();
});

// ========== SEARCH ==========
let searchTimeout;
document.getElementById('searchInput').addEventListener('input', e => {
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(() => { searchQuery = e.target.value.trim(); render(); }, 300);
});

// ========== READING PROGRESS BAR ==========
function updateProgressBar() {
  const winScroll = document.documentElement.scrollTop || document.body.scrollTop;
  const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
  const scrolled = height > 0 ? (winScroll / height) * 100 : 0;
  document.getElementById('progressBar').style.width = scrolled + '%';
}

// ========== STICKY MONTH (mobile) ==========
function updateStickyMonth() {
  const stickyEl = document.getElementById('stickyMonth');
  if (!stickyEl) return;
  const heroBottom = document.querySelector('.hero');
  if (!heroBottom) return;
  const pastHero = window.scrollY > heroBottom.offsetHeight;
  stickyEl.classList.toggle('visible', pastHero && currentVisibleMonth);
}

// ========== SCROLL ==========
const nav = document.getElementById('nav');
window.addEventListener('scroll', () => {
  nav.classList.toggle('scrolled', window.scrollY > 100);
  document.getElementById('backTop').classList.toggle('show', window.scrollY > 600);
  updateProgressBar();
  updateStickyMonth();
}, { passive: true });
document.getElementById('backTop').addEventListener('click', () => { window.scrollTo({ top: 0, behavior: 'smooth' }); });

// ========== MOBILE TIMELINE SHEET ==========
function buildMobileTimeline() {
  if (!allData) return;
  const content = document.getElementById('mobileSheetContent');
  if (!content) return;
  let html = '';
  let lastYear = '';
  allData.issues.forEach(issue => {
    if (issue.isBackground) return;
    const [year, month] = issue.date.split('-');
    if (year !== lastYear) {
      lastYear = year;
      html += `<div class="mobile-sheet-year">${year}</div><div class="mobile-sheet-months">`;
    }
    const monthName = MONTH_NAMES[month] || month;
    html += `<button class="mobile-sheet-chip" data-target="month-${issue.date}">${monthName.substring(0, 3)}</button>`;
    // Close months div before next year
    const nextIssue = allData.issues[allData.issues.indexOf(issue) + 1];
    if (!nextIssue || nextIssue.isBackground || nextIssue.date.split('-')[0] !== year) {
      html += `</div>`;
    }
  });
  content.innerHTML = html;

  // Click handlers for chips
  content.querySelectorAll('.mobile-sheet-chip').forEach(chip => {
    chip.addEventListener('click', () => {
      const target = document.getElementById(chip.dataset.target);
      if (target) {
        target.scrollIntoView({ behavior: 'smooth', block: 'start' });
        closeMobileSheet();
      }
    });
  });
}

function openMobileSheet() {
  document.getElementById('mobileTimelineSheet').classList.add('open');
  document.getElementById('mobileSheetOverlay').classList.add('show');
}
function closeMobileSheet() {
  document.getElementById('mobileTimelineSheet').classList.remove('open');
  document.getElementById('mobileSheetOverlay').classList.remove('show');
}

document.getElementById('mobileTimelineBtn').addEventListener('click', openMobileSheet);
document.getElementById('mobileSheetOverlay').addEventListener('click', closeMobileSheet);

// ========== INIT ==========
loadData();
</script>
</body>
</html>
