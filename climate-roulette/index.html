<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Climate Roulette â€” Tipping Point Monte Carlo</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7"></script>
    <script src="//cdn.jsdelivr.net/npm/globe.gl"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg: #0a0a0a;
            --surface: #111;
            --surface2: #1a1a1a;
            --border: #1e1e1e;
            --border2: #2a2a2a;
            --text: #e0e0e0;
            --text-dim: #888;
            --text-dimmer: #555;
            --text-heading: #ccc;
            --text-white: #fff;
            --cyan: #00d4ff;
            --cyan-bg: rgba(0,212,255,0.08);
            --red: #ef4444;
            --orange: #f59e0b;
            --green: #22c55e;
            --yellow: #fbbf24;
            --chart-grid: rgba(255,255,255,0.05);
            --chart-grid-light: rgba(255,255,255,0.03);
            --log-bg: rgba(0,0,0,0.3);
            --explainer-bg: rgba(0,212,255,0.04);
            --explainer-border: rgba(0,212,255,0.12);
        }

        [data-theme="light"] {
            --bg: #f5f5f5;
            --surface: #fff;
            --surface2: #f0f0f0;
            --border: #ddd;
            --border2: #ccc;
            --text: #333;
            --text-dim: #666;
            --text-dimmer: #999;
            --text-heading: #444;
            --text-white: #111;
            --cyan: #0088a3;
            --cyan-bg: rgba(0,136,163,0.08);
            --chart-grid: rgba(0,0,0,0.08);
            --chart-grid-light: rgba(0,0,0,0.04);
            --log-bg: rgba(0,0,0,0.04);
            --explainer-bg: rgba(0,136,163,0.06);
            --explainer-border: rgba(0,136,163,0.2);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            transition: background 1s;
        }

        .container { max-width: 1100px; margin: 0 auto; padding: 0 1.5rem; }

        header { text-align: center; padding: 2.5rem 1.5rem 1rem; }
        header h1 { font-size: 2rem; font-weight: 700; color: #fff; letter-spacing: -0.02em; }
        header .subtitle { margin-top: 0.4rem; font-size: 1rem; color: var(--text-dim); }
        header .explainer { margin-top: 0.8rem; font-size: 0.85rem; color: var(--text-dimmer); max-width: 700px; margin-left: auto; margin-right: auto; line-height: 1.6; }

        .panel { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; margin-top: 1.5rem; }
        .panel h2 { font-size: 1rem; font-weight: 600; color: var(--text-heading); margin-bottom: 1rem; }

        .roll-section { display: flex; align-items: center; gap: 2rem; flex-wrap: wrap; justify-content: center; }

        .temp-dial {
            width: 180px; height: 180px; border-radius: 50%; border: 3px solid var(--border2);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: var(--surface2); position: relative; transition: border-color 0.5s, box-shadow 0.5s;
        }
        .temp-dial.warming { border-color: var(--orange); box-shadow: 0 0 30px rgba(245,158,11,0.15); }
        .temp-dial.hot { border-color: var(--red); box-shadow: 0 0 30px rgba(239,68,68,0.2); }
        .temp-dial .temp-value { font-size: 2.8rem; font-weight: 700; color: var(--text-white); line-height: 1; transition: color 0.5s; }
        .temp-dial .temp-label { font-size: 0.72rem; color: var(--text-dim); margin-top: 0.2rem; text-align: center; }
        .temp-dial .temp-delta { font-size: 0.75rem; color: var(--cyan); margin-top: 0.15rem; text-align: center; }

        .roll-controls { display: flex; flex-direction: column; gap: 0.75rem; align-items: center; }

        .roll-btn {
            padding: 1rem 2.5rem; border: 2px solid var(--cyan); border-radius: 12px;
            background: rgba(0,212,255,0.1); color: var(--cyan); font-size: 1.1rem;
            font-weight: 700; cursor: pointer; transition: all 0.2s; letter-spacing: 0.05em; text-transform: uppercase;
        }
        .roll-btn:hover:not(:disabled) { background: rgba(0,212,255,0.2); box-shadow: 0 0 20px rgba(0,212,255,0.15); }
        .roll-btn:disabled { opacity: 0.35; cursor: not-allowed; }
        .roll-btn.rolling { animation: pulse 0.4s ease-in-out; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }

        .auto-run-row { display: flex; align-items: center; gap: 0.5rem; font-size: 0.82rem; color: var(--text-dim); }
        .auto-run-row input[type="range"] { width: 120px; accent-color: var(--cyan); }
        .auto-run-row .target-label { color: var(--cyan); font-weight: 600; min-width: 3rem; }

        .secondary-btn {
            padding: 0.5rem 1.2rem; border: 1px solid var(--border2); border-radius: 8px; background: var(--surface2);
            color: var(--text-heading); font-size: 0.82rem; font-weight: 500; cursor: pointer; transition: all 0.15s;
        }
        .secondary-btn:hover:not(:disabled) { background: var(--border2); border-color: var(--text-dimmer); color: var(--text-white); }
        .secondary-btn:disabled { opacity: 0.35; cursor: not-allowed; }

        .btn-row { display: flex; gap: 0.5rem; flex-wrap: wrap; justify-content: center; }

        .roll-log {
            margin-top: 1rem; max-height: 120px; overflow-y: auto; font-size: 0.78rem;
            color: var(--text-dim); line-height: 1.7; padding: 0.5rem; background: var(--log-bg); border-radius: 8px;
        }
        .roll-log .tip-event { color: var(--red); font-weight: 600; }
        .roll-log .safe-event { color: var(--text-dimmer); }
        .roll-log .cascade-event { color: var(--orange); font-weight: 500; }

        .tp-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.6rem; }
        .tp-card {
            background: var(--surface2); border: 1px solid var(--border2); border-radius: 8px;
            padding: 0.7rem; transition: all 0.3s; position: relative; overflow: hidden;
        }
        .tp-card .tp-name { font-size: 0.72rem; font-weight: 600; color: var(--text-heading); line-height: 1.3; margin-bottom: 0.3rem; }
        .tp-card .tp-abbrev { font-size: 0.6rem; color: var(--text-dimmer); font-weight: 500; letter-spacing: 0.05em; }
        .tp-card .tp-range { font-size: 0.65rem; color: var(--text-dim); margin-top: 0.25rem; }
        .tp-card .tp-prob-bar { height: 3px; background: var(--border2); border-radius: 2px; margin-top: 0.4rem; overflow: hidden; }
        .tp-card .tp-prob-fill { height: 100%; border-radius: 2px; background: var(--green); width: 0%; transition: width 0.3s, background 0.3s; }
        .tp-card .tp-status { font-size: 0.62rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.06em; margin-top: 0.3rem; }
        .tp-card.safe .tp-status { color: var(--green); }
        .tp-card.at-risk .tp-status { color: var(--orange); }
        .tp-card.at-risk { border-color: rgba(245,158,11,0.3); }
        .tp-card.at-risk .tp-prob-fill { background: var(--orange); }
        .tp-card.tipped { border-color: rgba(239,68,68,0.5); background: rgba(239,68,68,0.08); }
        .tp-card.tipped .tp-status { color: var(--red); }
        .tp-card.tipped .tp-prob-fill { background: var(--red); width: 100% !important; }
        .tp-card.cascade-flash { animation: cascadeFlash 0.6s ease-out; }
        @keyframes cascadeFlash { 0% { box-shadow: 0 0 0 0 rgba(245,158,11,0.6); } 100% { box-shadow: 0 0 0 0 rgba(245,158,11,0); } }

        .damage-summary { display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 1rem; }
        .damage-card { flex: 1; min-width: 140px; background: var(--surface2); border: 1px solid var(--border2); border-radius: 8px; padding: 0.8rem; text-align: center; }
        .damage-card .damage-value { font-size: 1.5rem; font-weight: 700; line-height: 1.2; }
        .damage-card .damage-label { font-size: 0.7rem; color: var(--text-dim); margin-top: 0.3rem; }
        .damage-card .damage-pct { font-size: 0.72rem; color: var(--text-dimmer); margin-top: 0.15rem; }
        .dmg-low { color: var(--green); } .dmg-med { color: var(--yellow); } .dmg-high { color: var(--orange); } .dmg-extreme { color: var(--red); }

        .dmg-selector { display: flex; align-items: center; gap: 0.5rem; font-size: 0.8rem; color: var(--text-dim); margin-top: 0.75rem; }
        .dmg-selector select { background: var(--surface2); border: 1px solid var(--border2); border-radius: 6px; color: var(--text); padding: 0.35rem 0.5rem; font-size: 0.8rem; }

        #mc-section { display: none; }
        .mc-controls { display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap; }
        .chart-container { position: relative; width: 100%; height: 350px; margin-top: 1rem; }

        .ergo-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-top: 1rem; }
        .ergo-card { background: var(--surface2); border: 1px solid var(--border2); border-radius: 10px; padding: 1rem; text-align: center; }
        .ergo-card h3 { font-size: 0.78rem; font-weight: 600; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem; }
        .ergo-card .ergo-value { font-size: 2rem; font-weight: 700; line-height: 1.2; }
        .ergo-card .ergo-sub { font-size: 0.72rem; color: var(--text-dimmer); margin-top: 0.3rem; }
        .ergo-card.mean { border-color: rgba(0,212,255,0.3); } .ergo-card.mean .ergo-value { color: var(--cyan); }
        .ergo-card.yours { border-color: rgba(251,191,36,0.3); } .ergo-card.yours .ergo-value { color: var(--yellow); }
        .ergo-card.worst { border-color: rgba(239,68,68,0.3); } .ergo-card.worst .ergo-value { color: var(--red); }

        .histogram-container { position: relative; width: 100%; height: 250px; margin-top: 1rem; }

        .explainer-box {
            background: var(--explainer-bg); border: 1px solid var(--explainer-border);
            border-radius: 10px; padding: 1.25rem; margin-top: 1.5rem; font-size: 0.85rem; color: var(--text-dim); line-height: 1.7;
        }
        .explainer-box strong { color: var(--text-heading); }
        .explainer-box .insight-stat { display: inline-block; background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.2); border-radius: 6px; padding: 0.2em 0.5em; color: var(--red); font-weight: 600; font-size: 0.82rem; }

        /* Globe */
        #globeContainer { width: 100%; height: 500px; position: relative; }
        #globeContainer canvas { border-radius: 8px; }
        .globe-legend { display: flex; gap: 1rem; justify-content: center; margin-top: 0.6rem; font-size: 0.7rem; color: var(--text-dim); }
        .globe-legend-item { display: flex; align-items: center; gap: 0.3rem; }
        .globe-legend-dot { width: 8px; height: 8px; border-radius: 50%; }

        .theme-toggle {
            position: fixed; top: 1rem; right: 1rem; z-index: 100;
            width: 40px; height: 40px; border-radius: 50%;
            border: 1px solid var(--border2); background: var(--surface);
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 1.1rem; transition: all 0.3s; color: var(--text);
        }
        .theme-toggle:hover { border-color: var(--text-dimmer); transform: scale(1.1); }

        .sound-toggle {
            position: fixed; top: 1rem; right: 3.5rem; z-index: 100;
            background: var(--surface2); border: 1px solid var(--border2); border-radius: 8px;
            padding: 0.4rem 0.7rem; font-size: 0.75rem; color: var(--text-dim); cursor: pointer; transition: all 0.15s;
        }
        .sound-toggle:hover { border-color: #555; color: #fff; }
        .sound-toggle.muted { opacity: 0.5; }

        .policy-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.75rem; margin-top: 1rem; }
        .policy-card { background: var(--surface2); border: 1px solid var(--border2); border-radius: 10px; padding: 1rem; text-align: center; transition: border-color 0.3s; }
        .policy-card h3 { font-size: 1.3rem; font-weight: 700; color: var(--text-white); margin-bottom: 0.5rem; }
        .policy-card .policy-survive { font-size: 1.8rem; font-weight: 700; line-height: 1.2; }
        .policy-card .policy-label { font-size: 0.68rem; color: var(--text-dim); margin-top: 0.25rem; }
        .policy-card .policy-detail { font-size: 0.7rem; color: var(--text-dimmer); margin-top: 0.4rem; line-height: 1.4; }
        .policy-card .policy-year { font-size: 0.72rem; color: var(--cyan); font-weight: 600; margin-top: 0.3rem; }

        .ticket-wrap { display: flex; flex-direction: column; align-items: center; gap: 1rem; }
        .ticket-canvas-wrap { border-radius: 12px; overflow: hidden; box-shadow: 0 4px 30px rgba(0,0,0,0.5); }
        .ticket-canvas-wrap canvas { display: block; max-width: 100%; height: auto; }
        .ticket-actions { display: flex; gap: 0.75rem; }

        footer { text-align: center; padding: 2rem 1.5rem 3rem; font-size: 0.75rem; color: var(--text-dimmer); line-height: 1.6; max-width: 700px; margin: 0 auto; }
        footer a { color: #777; text-decoration: none; }
        footer a:hover { color: #aaa; text-decoration: underline; }

        @media (max-width: 800px) {
            .tp-grid { grid-template-columns: repeat(2, 1fr); }
            .ergo-grid { grid-template-columns: 1fr; }
            .policy-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 600px) {
            header h1 { font-size: 1.5rem; }
            .container { padding: 0 1rem; }
            .roll-section { gap: 1rem; }
            .temp-dial { width: 140px; height: 140px; }
            .temp-dial .temp-value { font-size: 2.2rem; }
            .tp-grid { grid-template-columns: repeat(2, 1fr); gap: 0.4rem; }
            .tp-card { padding: 0.5rem; }
            .tp-card .tp-name { font-size: 0.65rem; }
            .chart-container { height: 280px; }
            .damage-summary { gap: 0.5rem; }
            .damage-card { min-width: 110px; padding: 0.6rem; }
            .damage-card .damage-value { font-size: 1.2rem; }
            .policy-grid { grid-template-columns: 1fr 1fr; gap: 0.5rem; }
            .policy-card { padding: 0.7rem; }
            .policy-card .policy-survive { font-size: 1.4rem; }
            #globeContainer { height: 350px; }
        }
    </style>
</head>
<body>
    <header>
        <h1>Climate Roulette</h1>
        <p class="subtitle">A Monte Carlo simulation of climate tipping points</p>
        <p class="explainer">Every 5 years of warming rolls the dice on 16 climate tipping points identified by Armstrong McKay et al. (2022). Choose an emissions pathway, then roll forward through time. Sometimes you reach 2100 and nothing tips. Sometimes permafrost collapses by 2040 and cascades everything. Click Roll to find out which Earth you're on.</p>
    </header>

    <button class="theme-toggle" id="themeToggle" title="Toggle light/dark mode" aria-label="Toggle theme">&#x1f319;</button>
    <button class="sound-toggle" id="soundToggle" title="Toggle sound">&#x1f50a; Sound On</button>

    <div class="container">

        <!-- Roll Section -->
        <div class="panel">
            <h2>Year &amp; Dice Roll</h2>
            <div class="roll-section">
                <div class="temp-dial" id="tempDial">
                    <div class="temp-value" id="yearDisplay">2025</div>
                    <div class="temp-label" id="tempValue">1.45&deg;C above pre-industrial</div>
                    <div class="temp-delta" id="tempDelta"></div>
                </div>
                <div class="roll-controls">
                    <div class="dmg-selector" style="margin-top:0;">
                        <label for="sspSelect">Emissions pathway:</label>
                        <select id="sspSelect">
                            <option value="SSP1-2.6">SSP1-2.6 (strong mitigation)</option>
                            <option value="SSP2-4.5" selected>SSP2-4.5 (moderate)</option>
                            <option value="SSP3-7.0">SSP3-7.0 (high emissions)</option>
                            <option value="SSP5-8.5">SSP5-8.5 (very high)</option>
                        </select>
                    </div>
                    <button class="roll-btn" id="rollBtn">Roll 5 Years</button>
                    <div class="auto-run-row">
                        <span>Auto-run to</span>
                        <input type="range" id="autoTarget" min="2030" max="2100" step="5" value="2070">
                        <span class="target-label" id="autoTargetLabel">2070</span>
                    </div>
                    <div class="btn-row">
                        <button class="secondary-btn" id="autoRunBtn">Auto-Run</button>
                        <button class="secondary-btn" id="resetBtn">Reset</button>
                    </div>
                </div>
            </div>
            <div class="roll-log" id="rollLog"></div>
        </div>

        <!-- Globe Map -->
        <div class="panel">
            <h2>Global Tipping Point Map</h2>
            <div id="globeContainer"></div>
            <div class="globe-legend">
                <div class="globe-legend-item"><div class="globe-legend-dot" style="background:var(--green)"></div> Safe</div>
                <div class="globe-legend-item"><div class="globe-legend-dot" style="background:var(--yellow)"></div> At Risk</div>
                <div class="globe-legend-item"><div class="globe-legend-dot" style="background:var(--orange)"></div> High Risk</div>
                <div class="globe-legend-item"><div class="globe-legend-dot" style="background:var(--red)"></div> Tipped</div>
            </div>
        </div>

        <!-- Tipping Point Grid -->
        <div class="panel">
            <h2>Tipping Points <span style="font-weight:400;color:var(--text-dimmer);font-size:0.8rem">&mdash; Armstrong McKay et al. 2022</span></h2>
            <div class="tp-grid" id="tpGrid"></div>
        </div>

        <!-- Current Damage -->
        <div class="panel">
            <h2>Economic Damage at Current Temperature</h2>
            <div class="dmg-selector">
                <label for="dmgSelect">Damage function:</label>
                <select id="dmgSelect">
                    <option value="nordhaus">Nordhaus DICE (conservative)</option>
                    <option value="howard" selected>Howard &amp; Sterner (meta-analysis)</option>
                    <option value="dietz">Dietz &amp; Stern (catastrophic)</option>
                    <option value="weitzman">Weitzman Fat-Tail</option>
                </select>
            </div>
            <div class="damage-summary" id="damageSummary"></div>
        </div>

        <!-- Monte Carlo Section -->
        <div class="panel" id="mc-section">
            <h2>Monte Carlo: 100 Parallel Earths</h2>
            <div class="mc-controls">
                <button class="roll-btn" id="mcRunBtn" style="font-size:0.9rem; padding:0.7rem 1.5rem;">Run 100 Simulations</button>
                <span id="mcStatus" style="font-size:0.8rem; color:var(--text-dim);"></span>
            </div>
            <div class="chart-container"><canvas id="survivalChart"></canvas></div>

            <h2 style="margin-top:1.5rem;">The Ergodicity Problem</h2>
            <div class="ergo-grid" id="ergoGrid">
                <div class="ergo-card mean">
                    <h3>Ensemble Mean</h3>
                    <div class="ergo-value" id="ergoMean">--</div>
                    <div class="ergo-sub">Average across 100 Earths</div>
                </div>
                <div class="ergo-card yours">
                    <h3>Your Trajectory</h3>
                    <div class="ergo-value" id="ergoYours">--</div>
                    <div class="ergo-sub">This Earth's outcome</div>
                </div>
                <div class="ergo-card worst">
                    <h3>Worst 5%</h3>
                    <div class="ergo-value" id="ergoWorst">--</div>
                    <div class="ergo-sub">95th percentile damage</div>
                </div>
            </div>

            <h2 style="margin-top:1.5rem;">Damage Distribution</h2>
            <div class="histogram-container"><canvas id="histogramChart"></canvas></div>

            <div class="explainer-box" id="ergoExplainer">
                <strong>Why does the mean mislead?</strong> Standard cost-benefit analysis averages across many hypothetical Earths &mdash; but we only live on one. Climate damages are multiplicative: once a tipping point fires, it compounds. The ensemble mean smooths over catastrophic trajectories, but if <em>your</em> Earth hits the tail, the damage is permanent. This is the ergodicity problem: the average across parallel worlds is not the average over time for a single world.
            </div>
        </div>

        <!-- Policy Lever -->
        <div class="panel" id="policy-section" style="display:none;">
            <h2>The Paris Agreement Gamble <span style="font-weight:400;color:var(--text-dimmer);font-size:0.8rem">&mdash; What does each target buy you?</span></h2>
            <div class="policy-grid" id="policyGrid"></div>
        </div>

        <!-- Lottery Ticket -->
        <div class="panel" id="ticket-section" style="display:none;">
            <h2>Your Climate Lottery Ticket</h2>
            <div class="ticket-wrap">
                <div class="ticket-canvas-wrap"><canvas id="ticketCanvas" width="600" height="380"></canvas></div>
                <div class="ticket-actions"><button class="secondary-btn" id="downloadTicket">Download Image</button></div>
            </div>
        </div>
    </div>

    <footer>
        Tipping point data: Armstrong McKay et al. (2022), <em>Science</em>. Cascade interactions: Wunderling et al. (2024).<br>
        Damage functions: Nordhaus DICE-2016R, Howard &amp; Sterner 2017, Dietz &amp; Stern 2015, Weitzman 2012.<br>
        World GDP baseline: ~$105 trillion (2024 nominal).<br>
        <a href="/">&larr; Back to Home</a>
    </footer>

    <script>
    'use strict';

    // =========================================================================
    // 1. TIPPING POINT DATA
    // =========================================================================
    const TIPPING_POINTS = [
        { id: 'GrIS', name: 'Greenland Ice Sheet', cat: 'core', min: 0.8, central: 1.5, max: 3.0, warming: 0.13, lat: 72, lon: -40, cascades: [{ target: 'AMOC', thresholdShift: -0.5 }] },
        { id: 'WAIS', name: 'West Antarctic Ice Sheet', cat: 'core', min: 1.0, central: 1.5, max: 3.0, warming: 0.05, lat: -79, lon: -100, cascades: [] },
        { id: 'EASB', name: 'East Antarctic Basins', cat: 'core', min: 2.0, central: 3.0, max: 6.0, warming: 0.02, lat: -75, lon: 110, cascades: [] },
        { id: 'AMOC', name: 'AMOC Collapse', cat: 'core', min: 1.4, central: 4.0, max: 8.0, warming: -0.5, lat: 45, lon: -30, cascades: [{ target: 'WAIS', thresholdShift: -0.3 }, { target: 'AMAZ', thresholdShift: -0.5 }] },
        { id: 'LABC', name: 'Labrador Sea Convection', cat: 'core', min: 1.1, central: 1.8, max: 3.8, warming: 0.0, lat: 58, lon: -55, cascades: [{ target: 'AMOC', thresholdShift: -0.2 }] },
        { id: 'BARI', name: 'Barents Sea Ice Loss', cat: 'core', min: 1.0, central: 1.6, max: 2.5, warming: 0.04, lat: 76, lon: 40, cascades: [{ target: 'GrIS', thresholdShift: -0.2 }, { target: 'PFAT', thresholdShift: -0.2 }] },
        { id: 'REEF', name: 'Coral Reef Die-off', cat: 'core', min: 1.0, central: 1.5, max: 2.0, warming: 0.0, lat: -15, lon: 150, cascades: [] },
        { id: 'PFAT', name: 'Abrupt Permafrost Thaw', cat: 'core', min: 1.0, central: 1.5, max: 2.3, warming: 0.15, lat: 68, lon: 100, cascades: [] },
        { id: 'PFTP', name: 'Permafrost Collapse (Yedoma)', cat: 'core', min: 1.0, central: 3.0, max: 6.0, warming: 0.3, lat: 65, lon: 135, cascades: [] },
        { id: 'AMAZ', name: 'Amazon Dieback', cat: 'regional', min: 2.0, central: 3.5, max: 6.0, warming: 0.2, lat: -5, lon: -60, cascades: [] },
        { id: 'BORF', name: 'Boreal Forest Dieback', cat: 'regional', min: 1.4, central: 4.0, max: 5.0, warming: 0.1, lat: 58, lon: 30, cascades: [] },
        { id: 'TUND', name: 'Boreal Northern Shift', cat: 'regional', min: 1.5, central: 4.0, max: 7.2, warming: 0.0, lat: 65, lon: -100, cascades: [] },
        { id: 'GLCR', name: 'Mountain Glacier Loss', cat: 'regional', min: 1.5, central: 2.0, max: 3.0, warming: 0.0, lat: 35, lon: 80, cascades: [] },
        { id: 'SAHL', name: 'Sahel/W. African Monsoon', cat: 'regional', min: 2.0, central: 2.8, max: 3.5, warming: 0.0, lat: 14, lon: 0, cascades: [] },
        { id: 'NSPG', name: 'N. Atlantic Subpolar Gyre', cat: 'regional', min: 1.1, central: 1.8, max: 3.8, warming: 0.0, lat: 55, lon: -35, cascades: [{ target: 'AMOC', thresholdShift: -0.2 }] },
        { id: 'AWSI', name: 'Arctic Winter Sea Ice', cat: 'regional', min: 4.5, central: 6.3, max: 8.7, warming: 0.05, lat: 85, lon: 0, cascades: [] }
    ];

    // =========================================================================
    // 2. DAMAGE FUNCTIONS
    // =========================================================================
    const WORLD_GDP = 105;

    const DAMAGE_FNS = {
        nordhaus: { name: 'Nordhaus DICE', fn: T => 0.00236 * T * T, desc: 'Conservative quadratic' },
        howard: { name: 'Howard & Sterner', fn: T => 0.01145 * T * T, desc: 'Meta-analysis, ~5x DICE' },
        dietz: { name: 'Dietz & Stern', fn: T => 1 - 1 / (1 + 0.05314 * T * T + 4 * Math.pow(T, 6.754)), desc: 'Catastrophic at high T' },
        weitzman: { name: 'Weitzman Fat-Tail', fn: T => 0.00236 * T * T + 5.07e-6 * Math.pow(T, 6.754), desc: 'DICE + fat tail term' }
    };

    function getDamage(temp, fnKey) {
        const frac = DAMAGE_FNS[fnKey].fn(temp);
        return { fraction: Math.min(frac, 1), trillions: Math.min(frac, 1) * WORLD_GDP };
    }

    function dmgColorClass(trillions) {
        if (trillions < 5) return 'dmg-low';
        if (trillions < 20) return 'dmg-med';
        if (trillions < 50) return 'dmg-high';
        return 'dmg-extreme';
    }

    // =========================================================================
    // 3. PROBABILITY MODEL
    // =========================================================================
    function tipCumulativeProb(T, element) {
        if (T < element.min) return 0;
        if (T > element.max) return 1;
        const k = Math.log(19) / Math.max(element.central - element.min, 0.1);
        return 1 / (1 + Math.exp(-k * (T - element.central)));
    }

    function tipStepProb(T, element) {
        const p1 = tipCumulativeProb(T, element);
        const p0 = tipCumulativeProb(T - 0.1, element);
        const pNot = 1 - p0;
        if (pNot <= 0) return 1;
        return Math.max(0, Math.min(1, (p1 - p0) / pNot));
    }

    // =========================================================================
    // 4. SSP SCENARIOS + YEAR MAPPING
    // =========================================================================
    const SSP_SCENARIOS = {
        'SSP1-2.6': { label: 'SSP1-2.6 (strong mitigation)', color: '#4c994c',
            points: [[2025,1.45],[2030,1.50],[2035,1.55],[2040,1.60],[2045,1.65],[2050,1.70],[2055,1.70],[2060,1.70],[2065,1.72],[2070,1.75],[2075,1.77],[2080,1.80],[2085,1.80],[2090,1.80],[2095,1.80],[2100,1.80]] },
        'SSP2-4.5': { label: 'SSP2-4.5 (moderate)', color: '#5078be',
            points: [[2025,1.45],[2030,1.50],[2035,1.57],[2040,1.65],[2045,1.77],[2050,1.90],[2055,2.00],[2060,2.10],[2065,2.20],[2070,2.30],[2075,2.40],[2080,2.50],[2085,2.57],[2090,2.65],[2095,2.67],[2100,2.70]] },
        'SSP3-7.0': { label: 'SSP3-7.0 (high emissions)', color: '#aa648c',
            points: [[2025,1.45],[2030,1.50],[2035,1.60],[2040,1.70],[2045,1.85],[2050,2.00],[2055,2.15],[2060,2.30],[2065,2.50],[2070,2.70],[2075,2.90],[2080,3.10],[2085,3.25],[2090,3.40],[2095,3.50],[2100,3.60]] },
        'SSP5-8.5': { label: 'SSP5-8.5 (very high)', color: '#be5050',
            points: [[2025,1.50],[2030,1.60],[2035,1.72],[2040,1.85],[2045,2.02],[2050,2.20],[2055,2.42],[2060,2.65],[2065,2.90],[2070,3.15],[2075,3.42],[2080,3.70],[2085,3.90],[2090,4.10],[2095,4.25],[2100,4.40]] }
    };

    function yearToTemp(year, sspKey) {
        const pts = SSP_SCENARIOS[sspKey].points;
        if (year <= pts[0][0]) return pts[0][1];
        if (year >= pts[pts.length - 1][0]) return pts[pts.length - 1][1];
        for (let i = 0; i < pts.length - 1; i++) {
            if (year >= pts[i][0] && year <= pts[i + 1][0]) {
                const frac = (year - pts[i][0]) / (pts[i + 1][0] - pts[i][0]);
                return pts[i][1] + frac * (pts[i + 1][1] - pts[i][1]);
            }
        }
        return pts[pts.length - 1][1];
    }

    function tempToYear(temp, sspKey) {
        const pts = SSP_SCENARIOS[sspKey].points;
        if (temp <= pts[0][1]) return pts[0][0];
        if (temp >= pts[pts.length - 1][1]) return pts[pts.length - 1][0];
        for (let i = 0; i < pts.length - 1; i++) {
            if (temp >= pts[i][1] && temp <= pts[i + 1][1]) {
                const frac = (temp - pts[i][1]) / (pts[i + 1][1] - pts[i][1]);
                return Math.round(pts[i][0] + frac * (pts[i + 1][0] - pts[i][0]));
            }
        }
        return 2100;
    }

    // =========================================================================
    // 5. SIMULATION ENGINE
    // =========================================================================
    class Simulation {
        constructor(startYear = 2025, sspKey = 'SSP2-4.5') {
            this.currentYear = startYear;
            this.currentTemp = yearToTemp(startYear, sspKey);
            this.effectiveWarming = 0;
            this.tippedSet = new Set();
            this.thresholdAdj = {};
            for (const tp of TIPPING_POINTS) this.thresholdAdj[tp.id] = 0;
            this.log = [];
            this.tippedAtTemp = {};
            this.tippedAtYear = {};
        }

        getAdjustedElement(tp) {
            return { ...tp, min: tp.min + this.thresholdAdj[tp.id], central: tp.central + this.thresholdAdj[tp.id], max: tp.max + this.thresholdAdj[tp.id] };
        }

        microStep(year) {
            this.currentTemp = Math.round((this.currentTemp + 0.1) * 100) / 100;
            const effectiveTemp = this.currentTemp + this.effectiveWarming;
            const result = { tipped: [], cascades: [] };
            for (const tp of TIPPING_POINTS) {
                if (this.tippedSet.has(tp.id)) continue;
                const adj = this.getAdjustedElement(tp);
                const prob = tipStepProb(effectiveTemp, adj);
                if (Math.random() < prob) {
                    this.tippedSet.add(tp.id);
                    this.tippedAtTemp[tp.id] = this.currentTemp;
                    this.tippedAtYear[tp.id] = year;
                    result.tipped.push(tp);
                    this.effectiveWarming += tp.warming;
                    for (const casc of tp.cascades) {
                        this.thresholdAdj[casc.target] += casc.thresholdShift;
                        result.cascades.push({ from: tp.id, to: casc.target, shift: casc.thresholdShift });
                    }
                }
            }
            return result;
        }

        stepYear(sspKey) {
            this.currentYear += 5;
            const targetTemp = yearToTemp(this.currentYear, sspKey);
            const startTemp = this.currentTemp;
            const result = { year: this.currentYear, startTemp, endTemp: targetTemp, effectiveTemp: 0, tipped: [], cascades: [] };

            while (this.currentTemp < targetTemp - 0.001) {
                const micro = this.microStep(this.currentYear);
                result.tipped.push(...micro.tipped);
                result.cascades.push(...micro.cascades);
            }
            this.currentTemp = Math.round(targetTemp * 100) / 100;
            result.effectiveTemp = this.currentTemp + this.effectiveWarming;
            return result;
        }

        runToYear(endYear, sspKey) {
            const results = [];
            while (this.currentYear < endYear) results.push(this.stepYear(sspKey));
            return results;
        }
    }

    function runMonteCarlo(n, endYear, sspKey, startYear = 2025) {
        const runs = [];
        for (let i = 0; i < n; i++) {
            const s = new Simulation(startYear, sspKey);
            const steps = s.runToYear(endYear, sspKey);
            runs.push({
                steps,
                tippedSet: new Set(s.tippedSet),
                tippedAtTemp: { ...s.tippedAtTemp },
                tippedAtYear: { ...s.tippedAtYear },
                effectiveWarming: s.effectiveWarming,
                finalTemp: s.currentTemp,
                finalEffectiveTemp: s.currentTemp + s.effectiveWarming
            });
        }
        return runs;
    }

    // =========================================================================
    // 6. UI STATE
    // =========================================================================
    let selectedSSP = 'SSP2-4.5';
    let sim = new Simulation(2025, selectedSSP);
    let currentDmgFn = 'howard';
    let userRunResults = [];
    let mcRuns = null;
    let survivalChart = null;
    let histogramChart = null;
    let globe = null;

    // =========================================================================
    // 7. RENDER TIPPING POINT GRID
    // =========================================================================
    const tpGrid = document.getElementById('tpGrid');

    function renderTPGrid() {
        tpGrid.innerHTML = '';
        const effectiveTemp = sim.currentTemp + sim.effectiveWarming;

        for (const tp of TIPPING_POINTS) {
            const card = document.createElement('div');
            card.className = 'tp-card';
            card.id = 'tp-' + tp.id;

            const isTipped = sim.tippedSet.has(tp.id);
            const adj = sim.getAdjustedElement(tp);
            const cumProb = isTipped ? 1 : tipCumulativeProb(effectiveTemp, adj);

            if (isTipped) card.classList.add('tipped');
            else if (cumProb > 0.1) card.classList.add('at-risk');
            else card.classList.add('safe');

            const statusText = isTipped
                ? 'TIPPED @ ' + sim.tippedAtTemp[tp.id].toFixed(1) + '\u00B0C (' + sim.tippedAtYear[tp.id] + ')'
                : cumProb < 0.01 ? 'Safe' : (cumProb * 100).toFixed(0) + '% cumulative risk';

            card.innerHTML = `
                <div class="tp-abbrev">${tp.cat.toUpperCase()} &middot; ${tp.id}</div>
                <div class="tp-name">${tp.name}</div>
                <div class="tp-range">${adj.min.toFixed(1)}&ndash;${adj.max.toFixed(1)}&deg;C (central: ${adj.central.toFixed(1)}&deg;C)</div>
                <div class="tp-prob-bar"><div class="tp-prob-fill" style="width:${Math.min(cumProb * 100, 100)}%"></div></div>
                <div class="tp-status">${statusText}</div>
            `;
            tpGrid.appendChild(card);
        }
    }

    // =========================================================================
    // 8. GLOBE (Globe.gl)
    // =========================================================================
    function buildGlobePointsData() {
        const effectiveTemp = sim.currentTemp + sim.effectiveWarming;
        return TIPPING_POINTS.map(tp => {
            const isTipped = sim.tippedSet.has(tp.id);
            const adj = sim.getAdjustedElement(tp);
            const cumProb = isTipped ? 1 : tipCumulativeProb(effectiveTemp, adj);
            let color;
            if (isTipped) color = '#ef4444';
            else if (cumProb > 0.5) color = '#f59e0b';
            else if (cumProb > 0.1) color = '#fbbf24';
            else color = '#22c55e';

            return {
                lat: tp.lat, lng: tp.lon, color,
                alt: isTipped ? 0.25 : (0.02 + cumProb * 0.2),
                radius: isTipped ? 0.7 : (0.3 + cumProb * 0.3),
                id: tp.id, name: tp.name, isTipped, cumProb, adj
            };
        });
    }

    function buildGlobeArcsData() {
        const arcs = [];
        for (const tp of TIPPING_POINTS) {
            if (!sim.tippedSet.has(tp.id)) continue;
            for (const casc of tp.cascades) {
                const toTp = TIPPING_POINTS.find(t => t.id === casc.target);
                if (!toTp) continue;
                arcs.push({
                    startLat: tp.lat, startLng: tp.lon,
                    endLat: toTp.lat, endLng: toTp.lon,
                    color: ['#f59e0b88', '#ef444488']
                });
            }
        }
        return arcs;
    }

    function globeTooltipHTML(d) {
        const statusText = d.isTipped
            ? '<span style="color:#ef4444;font-weight:600">TIPPED at ' + sim.tippedAtTemp[d.id].toFixed(1) + '\u00B0C (' + sim.tippedAtYear[d.id] + ')</span>'
            : d.cumProb < 0.01
            ? '<span style="color:#22c55e">Safe</span>'
            : '<span style="color:#f59e0b;font-weight:600">' + (d.cumProb * 100).toFixed(0) + '% cumulative risk</span>';
        return '<div style="background:rgba(0,0,0,0.9);color:#e0e0e0;padding:8px 12px;border-radius:8px;font-family:-apple-system,sans-serif;font-size:13px;border:1px solid #333;">'
            + '<div style="font-weight:600;color:#fff;margin-bottom:4px;">' + d.name + '</div>'
            + '<div style="color:#888;font-size:11px;">' + d.adj.min.toFixed(1) + '\u2013' + d.adj.max.toFixed(1) + '\u00B0C (central: ' + d.adj.central.toFixed(1) + '\u00B0C)</div>'
            + '<div style="margin-top:4px;">' + statusText + '</div></div>';
    }

    function initGlobe() {
        const container = document.getElementById('globeContainer');
        globe = new Globe(container)
            .globeImageUrl('//cdn.jsdelivr.net/npm/three-globe/example/img/earth-night.jpg')
            .backgroundColor('rgba(0,0,0,0)')
            .width(container.clientWidth)
            .height(500)
            .atmosphereColor('#1a6b8a')
            .atmosphereAltitude(0.15)
            .pointsData(buildGlobePointsData())
            .pointLat('lat')
            .pointLng('lng')
            .pointColor('color')
            .pointAltitude('alt')
            .pointRadius('radius')
            .pointLabel(d => globeTooltipHTML(d))
            .pointsMerge(false)
            .pointsTransitionDuration(400)
            .arcsData(buildGlobeArcsData())
            .arcStartLat('startLat')
            .arcStartLng('startLng')
            .arcEndLat('endLat')
            .arcEndLng('endLng')
            .arcColor('color')
            .arcDashLength(0.6)
            .arcDashGap(0.3)
            .arcDashAnimateTime(2000)
            .arcStroke(0.8)
            .arcsTransitionDuration(400);

        globe.controls().autoRotate = true;
        globe.controls().autoRotateSpeed = 0.5;
        globe.controls().enableZoom = true;

        window.addEventListener('resize', () => {
            if (globe) globe.width(container.clientWidth);
        });
    }

    function renderWorldMap() {
        if (!globe) return;
        globe.pointsData(buildGlobePointsData());
        globe.arcsData(buildGlobeArcsData());
    }

    // =========================================================================
    // 9. RENDER DAMAGE SUMMARY
    // =========================================================================
    const damageSummary = document.getElementById('damageSummary');

    function renderDamage() {
        const effectiveTemp = sim.currentTemp + sim.effectiveWarming;
        const tippedCount = sim.tippedSet.size;
        let html = '';
        for (const [key, df] of Object.entries(DAMAGE_FNS)) {
            const d = getDamage(effectiveTemp, key);
            const isSelected = key === currentDmgFn;
            const borderStyle = isSelected ? 'border-color: var(--cyan);' : '';
            html += `<div class="damage-card" style="${borderStyle}">
                <div class="damage-value ${dmgColorClass(d.trillions)}">$${d.trillions < 100 ? d.trillions.toFixed(1) : d.trillions.toFixed(0)}T</div>
                <div class="damage-label">${df.name}</div>
                <div class="damage-pct">${(d.fraction * 100).toFixed(1)}% of world GDP</div>
            </div>`;
        }
        html += `<div class="damage-card">
            <div class="damage-value" style="color:${tippedCount > 0 ? 'var(--red)' : 'var(--green)'}">${tippedCount}</div>
            <div class="damage-label">Tipping Points Triggered</div>
            <div class="damage-pct">Effective temp: ${effectiveTemp.toFixed(2)}&deg;C</div>
        </div>`;
        damageSummary.innerHTML = html;
    }

    // =========================================================================
    // 10. ROLL LOG
    // =========================================================================
    const rollLog = document.getElementById('rollLog');

    function addLogEntry(result) {
        let line;
        if (result.tipped.length > 0) {
            line = '<span class="safe-event">' + result.year + ': ' + result.startTemp.toFixed(1) + '&deg;C &rarr; ' + result.endTemp.toFixed(1) + '&deg;C</span>';
            for (const tp of result.tipped) {
                line += ' <span class="tip-event">&mdash; ' + tp.name + ' TIPPED!</span>';
            }
            for (const c of result.cascades) {
                line += ' <span class="cascade-event">[cascade: ' + c.from + '&rarr;' + c.to + ' ' + (c.shift > 0 ? '+' : '') + c.shift.toFixed(1) + '&deg;C]</span>';
            }
        } else {
            line = '<span class="safe-event">' + result.year + ': ' + result.endTemp.toFixed(1) + '&deg;C &mdash; safe</span>';
        }
        rollLog.innerHTML += line + '<br>';
        rollLog.scrollTop = rollLog.scrollHeight;
    }

    // =========================================================================
    // 11. UPDATE TEMPERATURE DISPLAY
    // =========================================================================
    function updateTempDial() {
        const yearEl = document.getElementById('yearDisplay');
        const tempEl = document.getElementById('tempValue');
        const deltaEl = document.getElementById('tempDelta');
        const dial = document.getElementById('tempDial');
        const effectiveTemp = sim.currentTemp + sim.effectiveWarming;

        yearEl.textContent = sim.currentYear;
        tempEl.textContent = sim.currentTemp.toFixed(1) + '\u00B0C above pre-industrial';

        if (sim.effectiveWarming !== 0) {
            const sign = sim.effectiveWarming > 0 ? '+' : '';
            deltaEl.textContent = 'Effective: ' + effectiveTemp.toFixed(2) + '\u00B0C (' + sign + sim.effectiveWarming.toFixed(2) + ' from feedbacks)';
        } else {
            deltaEl.textContent = '';
        }

        dial.classList.remove('warming', 'hot');
        if (sim.currentTemp >= 3.0) dial.classList.add('hot');
        else if (sim.currentTemp >= 2.0) dial.classList.add('warming');

        const t = Math.min(1, Math.max(0, (sim.currentTemp - 1.2) / 3.8));
        const isLight = document.documentElement.getAttribute('data-theme') === 'light';
        if (isLight) {
            const r = Math.round(245 - t * 20);
            const g = Math.round(245 - t * 30);
            const b = Math.round(245 - t * 40);
            document.body.style.background = 'rgb(' + r + ',' + g + ',' + b + ')';
        } else {
            const r = Math.round(10 + t * 25);
            const g = Math.round(10 - t * 5);
            const b = Math.round(10 - t * 5);
            document.body.style.background = 'rgb(' + r + ',' + Math.max(g,5) + ',' + Math.max(b,5) + ')';
        }
    }

    // =========================================================================
    // 12. BUTTON HANDLERS
    // =========================================================================
    const rollBtn = document.getElementById('rollBtn');
    const autoRunBtn = document.getElementById('autoRunBtn');
    const resetBtn = document.getElementById('resetBtn');
    const autoTarget = document.getElementById('autoTarget');
    const autoTargetLabel = document.getElementById('autoTargetLabel');
    const dmgSelect = document.getElementById('dmgSelect');
    const sspSelect = document.getElementById('sspSelect');

    autoTarget.addEventListener('input', () => { autoTargetLabel.textContent = autoTarget.value; });
    sspSelect.addEventListener('change', () => { selectedSSP = sspSelect.value; });
    dmgSelect.addEventListener('change', () => { currentDmgFn = dmgSelect.value; renderDamage(); if (mcRuns) renderErgoPanel(); });

    function doSingleRoll() {
        if (sim.currentYear >= 2100) return;
        rollBtn.classList.add('rolling');
        setTimeout(() => rollBtn.classList.remove('rolling'), 400);

        soundDiceRoll();

        const result = sim.stepYear(selectedSSP);
        userRunResults.push(result);
        addLogEntry(result);
        updateTempDial();
        renderTPGrid();
        renderWorldMap();
        renderDamage();

        if (result.tipped.length > 0) soundTip();
        if (result.cascades.length > 0) setTimeout(() => soundCascade(), 200);

        for (const c of result.cascades) {
            const card = document.getElementById('tp-' + c.to);
            if (card) { card.classList.add('cascade-flash'); setTimeout(() => card.classList.remove('cascade-flash'), 600); }
        }

        if (sim.currentYear >= 2050) {
            document.getElementById('mc-section').style.display = 'block';
        }

        if (sim.currentYear >= 2100) {
            rollBtn.disabled = true;
            autoRunBtn.disabled = true;
        }
    }

    rollBtn.addEventListener('click', doSingleRoll);

    autoRunBtn.addEventListener('click', () => {
        const targetYear = parseInt(autoTarget.value);
        if (sim.currentYear >= targetYear) return;
        rollBtn.disabled = true;
        autoRunBtn.disabled = true;

        const interval = setInterval(() => {
            if (sim.currentYear >= targetYear || sim.currentYear >= 2100) {
                clearInterval(interval);
                rollBtn.disabled = sim.currentYear >= 2100;
                autoRunBtn.disabled = sim.currentYear >= 2100;
                if (sim.currentYear >= 2050) document.getElementById('mc-section').style.display = 'block';
                renderLotteryTicket();
                return;
            }
            doSingleRoll();
        }, 200);
    });

    resetBtn.addEventListener('click', () => {
        sim = new Simulation(2025, selectedSSP);
        userRunResults = [];
        mcRuns = null;
        rollLog.innerHTML = '';
        rollBtn.disabled = false;
        autoRunBtn.disabled = false;
        document.body.style.background = 'var(--bg)';
        updateTempDial();
        renderTPGrid();
        renderWorldMap();
        renderDamage();
        document.getElementById('mc-section').style.display = 'none';
        document.getElementById('ergoMean').textContent = '--';
        document.getElementById('ergoYours').textContent = '--';
        document.getElementById('ergoWorst').textContent = '--';
        if (survivalChart) { survivalChart.destroy(); survivalChart = null; }
        if (histogramChart) { histogramChart.destroy(); histogramChart = null; }
        document.getElementById('policy-section').style.display = 'none';
        document.getElementById('ticket-section').style.display = 'none';
    });

    // =========================================================================
    // 13. MONTE CARLO
    // =========================================================================
    const mcRunBtn = document.getElementById('mcRunBtn');
    const mcStatus = document.getElementById('mcStatus');

    mcRunBtn.addEventListener('click', () => {
        mcRunBtn.disabled = true;
        mcStatus.textContent = 'Simulating...';
        setTimeout(() => {
            const endYear = Math.max(sim.currentYear, parseInt(autoTarget.value));
            mcRuns = runMonteCarlo(100, endYear, selectedSSP);
            mcStatus.textContent = '100 simulations complete (2025\u2013' + endYear + ')';
            mcRunBtn.disabled = false;
            renderSurvivalChart(endYear);
            renderErgoPanel();
            renderHistogram(endYear);
            updateErgoExplainer(endYear);
            runPolicyComparison();
            renderLotteryTicket();
        }, 50);
    });

    // =========================================================================
    // 14. SURVIVAL CHART
    // =========================================================================
    function renderSurvivalChart(endYear) {
        const yearSteps = [];
        for (let y = 2025; y <= endYear; y += 5) yearSteps.push(y);

        const survivalData = yearSteps.map(y => {
            let survived = 0;
            for (const run of mcRuns) {
                const tippedByYear = Object.values(run.tippedAtYear).filter(yr => yr <= y).length;
                if (tippedByYear === 0) survived++;
            }
            return { x: y, y: survived };
        });

        const avgTipped = yearSteps.map(y => {
            let total = 0;
            for (const run of mcRuns) {
                total += Object.values(run.tippedAtYear).filter(yr => yr <= y).length;
            }
            return { x: y, y: total / mcRuns.length };
        });

        if (survivalChart) survivalChart.destroy();
        const ctx = document.getElementById('survivalChart').getContext('2d');
        survivalChart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [
                    {
                        label: 'Runs with zero tipping points',
                        data: survivalData,
                        borderColor: 'rgba(34,197,94,0.8)',
                        backgroundColor: 'rgba(34,197,94,0.1)',
                        borderWidth: 2, fill: true, pointRadius: 2, tension: 0.2, yAxisID: 'y'
                    },
                    {
                        label: 'Avg tipping points triggered',
                        data: avgTipped,
                        borderColor: 'rgba(239,68,68,0.7)',
                        borderWidth: 2, borderDash: [4, 3], pointRadius: 0, tension: 0.2, yAxisID: 'y2'
                    }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                scales: {
                    x: {
                        type: 'linear',
                        title: { display: true, text: 'Year (' + SSP_SCENARIOS[selectedSSP].label + ')', color: '#777', font: { size: 11 } },
                        ticks: { color: '#666', font: { size: 10 }, callback: v => v.toString() },
                        grid: { color: 'rgba(255,255,255,0.05)' }
                    },
                    y: {
                        position: 'left', min: 0, max: 100,
                        title: { display: true, text: 'Runs surviving (no tips)', color: '#22c55e', font: { size: 11 } },
                        ticks: { color: '#22c55e', font: { size: 10 } },
                        grid: { color: 'rgba(255,255,255,0.05)' }
                    },
                    y2: {
                        position: 'right', min: 0,
                        title: { display: true, text: 'Avg tipping points', color: '#ef4444', font: { size: 11 } },
                        ticks: { color: '#ef4444', font: { size: 10 } },
                        grid: { drawOnChartArea: false }
                    }
                },
                plugins: {
                    legend: { labels: { color: '#999', font: { size: 11 }, usePointStyle: true, padding: 16 } },
                    tooltip: {
                        callbacks: {
                            title: items => {
                                if (items.length === 0) return '';
                                const y = items[0].parsed.x;
                                const temp = yearToTemp(y, selectedSSP);
                                return y + ' (' + temp.toFixed(1) + '\u00B0C under ' + selectedSSP + ')';
                            },
                            label: item => item.datasetIndex === 0 ? item.parsed.y + ' / 100 survive' : item.parsed.y.toFixed(1) + ' avg tips'
                        }
                    }
                }
            }
        });
    }

    // =========================================================================
    // 15. ERGODICITY PANEL
    // =========================================================================
    function renderErgoPanel() {
        if (!mcRuns || mcRuns.length === 0) return;
        const fnKey = currentDmgFn;
        const damages = mcRuns.map(run => getDamage(run.finalEffectiveTemp, fnKey).trillions);
        damages.sort((a, b) => a - b);

        const mean = damages.reduce((s, d) => s + d, 0) / damages.length;
        const p95 = damages[Math.floor(damages.length * 0.95)];
        const userEffTemp = sim.currentTemp + sim.effectiveWarming;
        const userDmg = getDamage(userEffTemp, fnKey).trillions;

        document.getElementById('ergoMean').textContent = '$' + mean.toFixed(1) + 'T';
        document.getElementById('ergoMean').className = 'ergo-value ' + dmgColorClass(mean);
        document.getElementById('ergoYours').textContent = '$' + userDmg.toFixed(1) + 'T';
        document.getElementById('ergoYours').className = 'ergo-value ' + dmgColorClass(userDmg);
        document.getElementById('ergoWorst').textContent = '$' + p95.toFixed(1) + 'T';
        document.getElementById('ergoWorst').className = 'ergo-value ' + dmgColorClass(p95);
    }

    // =========================================================================
    // 16. HISTOGRAM
    // =========================================================================
    function renderHistogram(endYear) {
        if (!mcRuns || mcRuns.length === 0) return;
        const fnKey = currentDmgFn;
        const damages = mcRuns.map(run => getDamage(run.finalEffectiveTemp, fnKey).trillions);
        const maxD = Math.max(...damages, 10);
        const binWidth = Math.max(1, Math.ceil(maxD / 20));
        const nBins = Math.ceil(maxD / binWidth) + 1;
        const bins = new Array(nBins).fill(0);
        const binLabels = [];
        for (let i = 0; i < nBins; i++) binLabels.push('$' + (i * binWidth) + '-' + ((i + 1) * binWidth) + 'T');
        for (const d of damages) { const idx = Math.min(nBins - 1, Math.floor(d / binWidth)); bins[idx]++; }
        const binColors = bins.map((_, i) => {
            const midVal = (i + 0.5) * binWidth;
            if (midVal < 5) return 'rgba(34,197,94,0.6)';
            if (midVal < 20) return 'rgba(251,191,36,0.6)';
            if (midVal < 50) return 'rgba(245,158,11,0.6)';
            return 'rgba(239,68,68,0.6)';
        });

        if (histogramChart) histogramChart.destroy();
        const ctx = document.getElementById('histogramChart').getContext('2d');
        histogramChart = new Chart(ctx, {
            type: 'bar',
            data: { labels: binLabels, datasets: [{ label: 'Number of simulations', data: bins, backgroundColor: binColors, borderColor: binColors.map(c => c.replace('0.6', '0.9')), borderWidth: 1 }] },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    x: { title: { display: true, text: 'Economic damage ($ trillions)', color: '#777', font: { size: 11 } }, ticks: { color: '#666', font: { size: 9 }, maxRotation: 45 }, grid: { color: 'rgba(255,255,255,0.03)' } },
                    y: { title: { display: true, text: 'Number of simulations', color: '#777', font: { size: 11 } }, ticks: { color: '#666', font: { size: 10 }, stepSize: 5 }, grid: { color: 'rgba(255,255,255,0.05)' } }
                },
                plugins: { legend: { display: false }, tooltip: { callbacks: { label: item => item.parsed.y + ' simulations' } } }
            }
        });
    }

    // =========================================================================
    // 17. ERGODICITY EXPLAINER UPDATE
    // =========================================================================
    function updateErgoExplainer(endYear) {
        if (!mcRuns || mcRuns.length === 0) return;
        const fnKey = currentDmgFn;
        const damages = mcRuns.map(run => getDamage(run.finalEffectiveTemp, fnKey).trillions);
        const catastrophic = damages.filter(d => d > 50).length;
        const mean = damages.reduce((s, d) => s + d, 0) / damages.length;
        const cascadeRuns = mcRuns.filter(r => r.tippedSet.size >= 3).length;
        const endTemp = yearToTemp(endYear, selectedSSP);

        document.getElementById('ergoExplainer').innerHTML = '<strong>Why does the mean mislead?</strong> Standard cost-benefit analysis averages across many hypothetical Earths &mdash; but we only live on one. Climate damages are multiplicative: once a tipping point fires, it compounds. The ensemble mean smooths over catastrophic trajectories, but if <em>your</em> Earth hits the tail, the damage is permanent.<br><br>'
            + 'Across 100 simulations to ' + endYear + ' (' + endTemp.toFixed(1) + '&deg;C under ' + selectedSSP + '): the mean damage is <strong>$' + mean.toFixed(1) + 'T</strong> using ' + DAMAGE_FNS[fnKey].name + ', but '
            + '<span class="insight-stat">' + catastrophic + '% of runs exceeded $50T in damages</span> and '
            + '<span class="insight-stat">' + cascadeRuns + '% triggered 3+ tipping cascades</span>. '
            + 'The mean hides the tail. This is the ergodicity problem: the average across parallel worlds is not the average over time for a single world.';
    }

    // =========================================================================
    // 18. SOUND ENGINE
    // =========================================================================
    let audioCtx = null;
    let soundEnabled = true;
    const soundToggle = document.getElementById('soundToggle');

    function getAudioCtx() {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        return audioCtx;
    }

    function playTone(freq, duration, type, volume) {
        if (!soundEnabled) return;
        type = type || 'sine'; volume = volume || 0.15;
        try {
            const ctx = getAudioCtx();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, ctx.currentTime);
            gain.gain.setValueAtTime(volume, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + duration);
            osc.connect(gain); gain.connect(ctx.destination);
            osc.start(ctx.currentTime); osc.stop(ctx.currentTime + duration);
        } catch(e) {}
    }

    function playNoise(duration, volume) {
        if (!soundEnabled) return;
        volume = volume || 0.08;
        try {
            const ctx = getAudioCtx();
            const bufferSize = ctx.sampleRate * duration;
            const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
            const source = ctx.createBufferSource();
            source.buffer = buffer;
            const gain = ctx.createGain();
            gain.gain.setValueAtTime(volume, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + duration);
            const filter = ctx.createBiquadFilter();
            filter.type = 'bandpass'; filter.frequency.value = 800; filter.Q.value = 0.5;
            source.connect(filter); filter.connect(gain); gain.connect(ctx.destination);
            source.start();
        } catch(e) {}
    }

    function soundDiceRoll() { playNoise(0.15, 0.06); setTimeout(() => playTone(600, 0.08, 'triangle', 0.1), 100); }
    function soundTip() { playTone(200, 0.6, 'sawtooth', 0.12); setTimeout(() => playTone(150, 0.8, 'sawtooth', 0.1), 150); }
    function soundCascade() { [0, 80, 160, 240].forEach((delay, i) => { setTimeout(() => playTone(800 - i * 100, 0.2, 'sine', 0.08), delay); }); }

    soundToggle.addEventListener('click', () => {
        soundEnabled = !soundEnabled;
        soundToggle.textContent = soundEnabled ? '\u{1F50A} Sound On' : '\u{1F507} Sound Off';
        soundToggle.classList.toggle('muted', !soundEnabled);
        if (soundEnabled) getAudioCtx();
    });

    // =========================================================================
    // 19. POLICY LEVER COMPARISON
    // =========================================================================
    function runPolicyComparison() {
        const targets = [1.5, 2.0, 2.5, 3.0];
        const nRuns = 200;
        const grid = document.getElementById('policyGrid');
        grid.innerHTML = '';

        for (const target of targets) {
            const targetYear = tempToYear(target, selectedSSP);
            const runs = runMonteCarlo(nRuns, Math.min(targetYear, 2100), selectedSSP);
            const zeroTips = runs.filter(r => r.tippedSet.size === 0).length;
            const survivalPct = Math.round(zeroTips / nRuns * 100);
            const avgTips = (runs.reduce((s, r) => s + r.tippedSet.size, 0) / nRuns).toFixed(1);
            const damages = runs.map(r => getDamage(r.finalEffectiveTemp, currentDmgFn).trillions);
            const meanDmg = damages.reduce((s, d) => s + d, 0) / damages.length;
            const maxDmg = Math.max(...damages);

            let survColor;
            if (survivalPct >= 70) survColor = 'var(--green)';
            else if (survivalPct >= 40) survColor = 'var(--yellow)';
            else if (survivalPct >= 15) survColor = 'var(--orange)';
            else survColor = 'var(--red)';

            const card = document.createElement('div');
            card.className = 'policy-card';
            card.innerHTML = '<h3>' + target.toFixed(1) + '&deg;C</h3>'
                + '<div class="policy-survive" style="color:' + survColor + '">' + survivalPct + '%</div>'
                + '<div class="policy-label">chance of zero tipping points</div>'
                + '<div class="policy-detail">Avg ' + avgTips + ' tips &middot; Mean $' + meanDmg.toFixed(0) + 'T damage<br>Worst case: $' + maxDmg.toFixed(0) + 'T</div>'
                + '<div class="policy-year">~' + targetYear + ' under ' + selectedSSP + '</div>';
            grid.appendChild(card);
        }

        document.getElementById('policy-section').style.display = 'block';
    }

    // =========================================================================
    // 20. LOTTERY TICKET
    // =========================================================================
    function renderLotteryTicket() {
        const canvas = document.getElementById('ticketCanvas');
        const ctx = canvas.getContext('2d');
        const W = 600, H = 380;
        canvas.width = W; canvas.height = H;

        const grad = ctx.createLinearGradient(0, 0, W, H);
        grad.addColorStop(0, '#0f1923'); grad.addColorStop(1, '#1a0a0a');
        ctx.fillStyle = grad; ctx.fillRect(0, 0, W, H);

        ctx.strokeStyle = '#333'; ctx.lineWidth = 2; ctx.strokeRect(4, 4, W - 8, H - 8);
        ctx.setLineDash([8, 5]); ctx.strokeStyle = '#444'; ctx.lineWidth = 1; ctx.strokeRect(12, 12, W - 24, H - 24); ctx.setLineDash([]);

        ctx.fillStyle = '#fff'; ctx.font = 'bold 22px -apple-system, BlinkMacSystemFont, sans-serif'; ctx.textAlign = 'center';
        ctx.fillText('CLIMATE LOTTERY TICKET', W / 2, 45);
        ctx.fillStyle = '#666'; ctx.font = '11px -apple-system, sans-serif';
        ctx.fillText('Climate Roulette \u2022 ' + selectedSSP + ' \u2022 Your trajectory on this Earth', W / 2, 63);

        ctx.strokeStyle = '#333'; ctx.lineWidth = 1; ctx.beginPath(); ctx.moveTo(30, 75); ctx.lineTo(W - 30, 75); ctx.stroke();

        const effectiveTemp = sim.currentTemp + sim.effectiveWarming;
        const tippedList = Array.from(sim.tippedSet);
        const dmg = getDamage(effectiveTemp, currentDmgFn);

        ctx.textAlign = 'left'; ctx.fillStyle = '#aaa'; ctx.font = '12px -apple-system, sans-serif';
        ctx.fillText('YEAR REACHED', 30, 100);
        ctx.fillStyle = '#00d4ff'; ctx.font = 'bold 36px -apple-system, sans-serif';
        ctx.fillText(sim.currentYear.toString(), 30, 138);

        ctx.fillStyle = effectiveTemp >= 3 ? '#ef4444' : effectiveTemp >= 2 ? '#f59e0b' : '#22c55e';
        ctx.font = 'bold 20px -apple-system, sans-serif';
        ctx.fillText(sim.currentTemp.toFixed(1) + '\u00B0C', 140, 135);

        if (sim.effectiveWarming !== 0) {
            ctx.fillStyle = '#00d4ff'; ctx.font = '13px -apple-system, sans-serif';
            ctx.fillText('(eff: ' + effectiveTemp.toFixed(2) + '\u00B0C)', 220, 135);
        }

        ctx.fillStyle = '#aaa'; ctx.font = '12px -apple-system, sans-serif'; ctx.textAlign = 'right';
        ctx.fillText('ECONOMIC DAMAGE (' + DAMAGE_FNS[currentDmgFn].name + ')', W - 30, 100);
        ctx.fillStyle = dmg.trillions >= 50 ? '#ef4444' : dmg.trillions >= 20 ? '#f59e0b' : dmg.trillions >= 5 ? '#fbbf24' : '#22c55e';
        ctx.font = 'bold 32px -apple-system, sans-serif';
        ctx.fillText('$' + (dmg.trillions < 100 ? dmg.trillions.toFixed(1) : dmg.trillions.toFixed(0)) + 'T', W - 30, 135);
        ctx.fillStyle = '#666'; ctx.font = '11px -apple-system, sans-serif';
        ctx.fillText((dmg.fraction * 100).toFixed(1) + '% of world GDP', W - 30, 155);

        ctx.strokeStyle = '#2a2a2a'; ctx.beginPath(); ctx.moveTo(30, 175); ctx.lineTo(W - 30, 175); ctx.stroke();

        ctx.textAlign = 'left'; ctx.fillStyle = '#aaa'; ctx.font = '12px -apple-system, sans-serif';
        ctx.fillText('TIPPING POINTS TRIGGERED: ' + tippedList.length + ' / 16', 30, 198);

        const cols = 3, colW = (W - 60) / cols;
        tippedList.forEach((id, i) => {
            const tp = TIPPING_POINTS.find(t => t.id === id);
            const col = i % cols, row = Math.floor(i / cols);
            const x = 30 + col * colW, y = 218 + row * 22;
            ctx.fillStyle = '#ef4444'; ctx.beginPath(); ctx.arc(x + 5, y - 3, 3, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = '#ccc'; ctx.font = '11px -apple-system, sans-serif';
            ctx.fillText(tp ? tp.name : id, x + 14, y);
            ctx.fillStyle = '#666'; ctx.font = '10px -apple-system, sans-serif';
            const tYear = sim.tippedAtYear[id];
            if (tYear) ctx.fillText('@ ' + tYear, x + 14 + (tp ? ctx.measureText(tp.name).width + 4 : 30), y);
        });

        if (tippedList.length === 0) {
            ctx.fillStyle = '#22c55e'; ctx.font = 'bold 14px -apple-system, sans-serif';
            ctx.fillText('None! You survived.', 30, 222);
        }

        const bottomY = H - 35;
        ctx.fillStyle = '#1a1a1a'; ctx.fillRect(12, bottomY - 5, W - 24, 30);
        ctx.fillStyle = '#555'; ctx.font = '10px -apple-system, sans-serif'; ctx.textAlign = 'center';
        const dateStr = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        ctx.fillText('Generated ' + dateStr + ' \u2022 Armstrong McKay et al. 2022 \u2022 Climate Roulette', W / 2, bottomY + 12);

        document.getElementById('ticket-section').style.display = 'block';
    }

    document.getElementById('downloadTicket').addEventListener('click', () => {
        const canvas = document.getElementById('ticketCanvas');
        const link = document.createElement('a');
        link.download = 'climate-lottery-ticket.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
    });

    // =========================================================================
    // 21. INIT
    // =========================================================================
    // =========================================================================
    // 22. THEME TOGGLE
    // =========================================================================
    (function() {
        const toggle = document.getElementById('themeToggle');
        const html = document.documentElement;

        function setTheme(theme) {
            html.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            toggle.textContent = theme === 'dark' ? '\u{1F319}' : '\u2600\uFE0F';
            toggle.title = theme === 'dark' ? 'Switch to light mode' : 'Switch to dark mode';

            // Update globe earth texture for light/dark
            if (globe) {
                const img = theme === 'light'
                    ? '//cdn.jsdelivr.net/npm/three-globe/example/img/earth-blue-marble.jpg'
                    : '//cdn.jsdelivr.net/npm/three-globe/example/img/earth-night.jpg';
                globe.globeImageUrl(img);
            }
        }

        const saved = localStorage.getItem('theme');
        if (saved) setTheme(saved);
        else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) setTheme('light');

        toggle.addEventListener('click', () => {
            const current = html.getAttribute('data-theme') || 'dark';
            setTheme(current === 'dark' ? 'light' : 'dark');
        });
    })();

    // =========================================================================
    // 23. INIT
    // =========================================================================
    initGlobe();
    renderTPGrid();
    renderDamage();
    updateTempDial();

    // Apply saved theme on load (for globe texture)
    if (localStorage.getItem('theme') === 'light' && globe) {
        globe.globeImageUrl('//cdn.jsdelivr.net/npm/three-globe/example/img/earth-blue-marble.jpg');
    }

    </script>
</body>
</html>
